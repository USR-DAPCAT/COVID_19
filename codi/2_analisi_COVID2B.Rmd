---
title: "Impacto de la  diabetes mellitus en personas hospitalizadas por COVID19."
subtitle: 'OLA 1: data 01.01.2020 – 30.06.2020 '
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# 0. Estado:

> Des / 2020


Eventos:

&check; Traducir al inglés los gáficos para el artículo a través del Conductor <br/>



> Nov / 2020


Eventos:

&check; Hacer Modelos con interacciones y recalcular modelos con orden de variables <br/>
&check; Añadir complicaciones neurológicas <br/>
&check; Tabla estratificado por sexo para pacientes no diabéticos <br/>
&check; Quitar los fármacos de los modelos <br/>
&check; Arreglar la tabla de laboratorio añadiendo [stringsAsFactors=F] <br/>
&check; Las curvas spline con los nuevos datos <br/>
&check; Añadidos modelos no paramétricos para estudiar efecto no lineal  <br/>
&check; Graficar Splines de glucosa de modelos finales <br/>



**Últimas actualizaciones** 

**Realizado**

> Mayo/Junio/2021

&check; Estudiar la primera ola, a partir de la ultima base de datos Julio.2020  <br/>


> Febrero/2021

&check; Mejora de los modelos no paramétricos con término spline(Glucosa)  <br/>

> Setiembre/2020

&check; Ampliar tablas descriptivas P25, Median , P75 etc.. <br/>
&check; Cálculo de nuevas variable IFCC HBA1C, agrupador Comp_cardiovascular <br/>
&check; Calcular y añadir p valores en tabla 2 <br/>
&check; Actualizaciones modelos de mortalidad modelo definitivo <br/>
&check; actualizaciones nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Modelos por subgrupos <br/>
&check; Forest plot de modelos <br/>


> Agost/2020

&check; Nuevos modelos de mortalidad  <br/>
&check; Nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Comprobar valores de máximos de glucosa basal. <br/>

> Agost/2020

&check; Revisar código (Split script & Review)  <br/>
&check; Canvi de criteri de DM a: HB>=6.5 y/o Glucemia >=200 <br/>
&check; Generar tabla plana <br/>
&check; Nuevos modelos de mortalidad <br/>
&check; Nuevos modelos de ingreso en UCI <br/>

> Juliol/2020

&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Mortalidad <br/>

>

&check; Lectura / importación de archivos  <br/>
&check; Generación de conductors   <br/>
&check; Revisión de códigos  <br/>
&check; Agregación de datos segun protocolo <br/>
&check; Cálculo de varibles y recodificaciones <br/>
&check; Descriptiva exploratoria <br/>
&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Moeratlidad <br/>

**Pendent**

* Revisión y depuración d'errors 

# Análisis

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")

##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

# source(here::here("codi/Flowchart_Box_Final2.r"))
# source(here::here("codi/criteris_exclusio_diagrama2.r"))


# Llanço taula i camp que vull etiquetar i cambia nom del camp en funció d'etiqueta

etiquetar_taula<-function(taula=resumtotal,camp="variable",taulavariables="variables_R.xls",camp_descripcio="descripcio2",idcamp="camp") {
  
  # taula=porca
  # taulavariables=conductor
  # camp="Parameter"
  # camp_descripcio="desc_model"
  # idcamp="camp2"

  ####  Llegir etiquetes i variables a analitzar ####
  variables <- read_conductor(taulavariables)
  camp_sym<-sym(camp)
  idcamp_sym<-sym(camp_sym)

  # Canviar nom de camp de variables al de la taula 
  # colnames(variables)[colnames(variables)=="camp"] <- camp
  colnames(variables)[colnames(variables)==idcamp] <- camp

  # Canviar arguments per ser evaluats
  camp_eval<-sym(camp)
  camp_descripcio_eval<-sym(camp_descripcio)
  # Canviar el format de la taula 
  taula %>% left_join(dplyr::select(variables,c(!!camp_eval,camp_descripcio)),by=quo_name(camp_eval)) %>% 
    rename(descripcio=!!camp_descripcio) %>% 
    mutate(!!camp_eval:=descripcio) %>% 
    dplyr::select(-descripcio)
 
}

# Cambia nom dels elements d'un vector 



```


```{r lectura, include = FALSE}

#canviat 10.V.2021!

load(here::here("COVID2b.Rdata"))





```





## 3.Descriptivo general


```{r resultats1, include=T}

#####################################################################################################


formula<-formula.text("Taula00B",y="wave",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,method =2,
           Q1 = 0, Q3 = 1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = TRUE,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 1a. Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso,  si ha habido, datos del paso por UCI, si ha habido.Todos los pacientes.**")

#####################################################################################################

descrTable(formula,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 1b. Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso,  si ha habido, datos del paso por UCI, si ha habido.Todos los pacientes.**")




TAULA_PLANA_exc_b<-TAULA_PLANA_exc%>%filter(GRUP_DIABETIC_CAT!="No Diabetes")



descrTable(formula,method =2,
           Q1 = 0, Q3 = 1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = F,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 2a.Solo DIABETICOS:  Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso,  si ha habido, datos del paso por UCI, si ha habido.Todos los pacientes.**")

#####################################################################################################

descrTable(formula,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 2b.Solo DIABETICOS:  Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso,  si ha habido, datos del paso por UCI, si ha habido.Todos los pacientes.**")

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.STATINS2=ifelse(FX.STATINS=="Yes" ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI_STATINS=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") & (FX.STATINS=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.NO_ARB_ACEI_STATINS=ifelse( FX.ARB=="No" & FX.ACEI=="No" & FX.STATINS=="No" ,"Si","No"))
#
#dt_temp<-TAULA_PLANA_exc%>%select(PATIENT.ID,FX.ARB,FX.ACEI,FX.STATINS,FX.STATINS2,FX.ARB_ACEI,FX.ARB_ACEI_STATINS,FX.NO_ARB_ACEI_STATINS)


save(TAULA_PLANA_exc
     ,file=here::here("COVID2c.Rdata"))


```


```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


