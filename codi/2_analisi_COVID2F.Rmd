---
title: "Impacte de la diabetis mellitus en persones hospitalitzades per COVID19.DM2(n=402)"
subtitle: 'Onada 1: data 01.01.2020 – 30.06.2020 '
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# Estat:


#### Últimes actualitzacions:

Julio /2021

&check; Generar variable nova farmacs combinats  <br/>
&check; Reclasificar DM2 / Tipus de diabetis, i G_DIABETIC en funció de Antecedents, fàrmacs ADO i Hba1c  <br/>
&check; Refer descriptiva + models <br/>
&check; Separa analisis en 2 poblacions: 1. Global i 2 DM2 versus Pob no DM; <br/>
&check; analisis DM1+DM2(n=406) pels articles; <br/>
&check; analisis DM2(n=402) pels articles; <br/>

- Pendent: 

Revisió i depuració 

# Anàlisi

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#18.08.2021
#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")

##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

# source(here::here("codi/Flowchart_Box_Final2.r"))
# source(here::here("codi/criteris_exclusio_diagrama2.r"))


```


```{r lectura, include = FALSE}

#canviat 10.V.2021!

load(here::here("COVID2c.Rdata"))


```



```{r preparacio, include=T}

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.STATINS2=ifelse(FX.STATINS=="Yes" ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI_STATINS=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") & (FX.STATINS=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.NO_ARB_ACEI_STATINS=ifelse( FX.ARB=="No" & FX.ACEI=="No" & FX.STATINS=="No" ,"Si","No"))


```

```{r, include=TRUE}

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar(taulavariables=conductor,camp_descripcio="descripcio2")

```

## Analisis exploratori GLOBAL (N=2308)

### Generar grup de fàrmacs excluyents i verificació 

```{r, include=TRUE}
vars_fx<-c("FX.ACEI","FX.STATINS","FX.ARB")
TAULA_PLANA_exc<- TAULA_PLANA_exc %>% tidyr::unite(FX.ACEI_STATINS_ARB,vars_fx,sep="_",remove = F) 


# Capturar variable combinada d'aquests farmacs excloents
popa<-read_conductor(conductor,sheet="COMBI_FARMACOS") %>% select(FX.ACEI_STATINS_ARB,FX.COMBI)

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  left_join(popa,by="FX.ACEI_STATINS_ARB")
# Etiquetar valors
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar_valors(variables_factors = conductor,fulla = "COMBI_FARMACOS",camp_etiqueta = "Descripcio")

# Taula de verificació
descrTable(FX.COMBI ~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB + FX.ARB_ACEI, data= TAULA_PLANA_exc, method = 3, show.p.overall = F) %>% export2md()


rm(popa)

```

### Reclasificació de Diabetis tipus 2, tipus 1 i altres i verificació de classificació 

```{r, include=TRUE}



# Recalcular DM2 en funció de Diagnostic, tractament ADO o basal_HBA1C>=6.5  SENSE QUE SIGUI DM1
# GRUP_DM2 ---> DG.DM2, | FX.ADO | basal_HBA1C>=6.5 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate (GRUP_DM2=case_when(
                                                  DG.DM1=="No" & (DG.DM2=="Yes" | FX.ADO=="Yes") ~ "Yes",
                                                  DG.DM1=="Yes" & FX.ADO=="Yes" ~ "Yes",
                                                  DG.DM1=="No" & basal_pacient_valor_HBA1C_>=6.5 ~ "Yes",
                                                  TRUE ~ "No") ) 
# Reclassificar tipus de diabetis 
TAULA_PLANA_exc<-
  TAULA_PLANA_exc %>% mutate(GRUP_DIABETIC_CAT2=case_when(GRUP_DM2=="Yes"~ "2.DM2",
                                                        DG.DM1=="Yes"~"1.DM1",
                                                        DG.DM_SEC=="Yes" & GRUP_DM2=="No" & DG.DM1=="No" ~"3.Others DM",
                                                        TRUE ~ "0.No Diabetes")) 

# Reclassificar altres tipus de DM en funció de GLUCOSA BASAL>=200 O qualsevol tipus de DM, INSULINAS
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  mutate(GRUP_DIABETIC_CAT2=case_when(GRUP_DIABETIC_CAT2=="0.No Diabetes" 
                                      & (FX.INSULINAS_INTM=="Yes" | FX.INSULINAS_LENT=="Yes" | FX.INSULINAS_Rap=="Yes" | GLU_1>=200)  ~ "3.Others DM", 
                                        TRUE ~ GRUP_DIABETIC_CAT2 ))


# Reclassificar variable G_DIABETIC 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate(G_DIABETIC=if_else(GRUP_DIABETIC_CAT2=="0.No Diabetes","No","Yes"))

# Verificar tema 
descrTable(GRUP_DM2~DG.DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()


# Verificar tema 
descrTable(G_DIABETIC ~ GRUP_DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()

# Verificar tema 
descrTable(G_DIABETIC ~ GRUP_DIABETIC_CAT2,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()

# Reclassificar altres DM en funció de GLUCOSA BASAL>=200 O qualsevol tipus de DM, INSULINAS
descrTable(GRUP_DIABETIC_CAT2 ~ G_DIABETIC + FX.INSULINAS_INTM + FX.INSULINAS_LENT +FX.INSULINAS_Rap + FX.ADO + GLU_1 + basal_pacient_valor_HBA1C_,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()


```

# 1. Descriptiva general i per convinació de fàrmacs.DM2(n=402)

```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)


# FILTREM només per DM2+DM1, per equiperar-ho als articles internacionals.

dades<-TAULA_PLANA_exc%>% filter(GRUP_DIABETIC_CAT2=="2.DM2")

#dades$GRUP_DIABETIC_CAT2

formula<-formula.text("Taula00C",y="FX.COMBI",taulavariables = conductor,dt=dades)

descrTable(formula,method =1,
           data=dades,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F,show.all = T) %>% 
  export2md(caption="Característiques de les persones incloses en el conjunt de dades Covid-19 a la Onada 1: data 01.01.2020 – 30.06.2020.Per combinacions de fàrmacs ACE / ARB / ESTATINES")
#


```

# 2. Analisis d'associació amb Mortalitat i Mortalitat/UCI.DM2(n=402)

## 2.1. Estimació d'OR crus i ajustats mitjançant models de regressió logística.DM2 (n=402)

```{r, include=TRUE}

formu<-formula.text("ajuste13b",a=c("GRUP_DM2"), "Death2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()

formu<-formula.text("ajuste13b",a=c("GRUP_DM2"), "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()

```

## Model taula 3 (Adjusted for  CKD) but not other microvascular disease.DM2 (n=402)

```{r, include=TRUE}
# Models ajustats

formu<-"Death2 ~ FX.STATINS + FX.ARB_ACEI  + DG.CKD"
model<-glm(formu,data = dades, family = "binomial") 

model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Mortality models",
                                        p.style = "numeric_stars")


formu<-"Death_DG_Ad_UCI2 ~ FX.STATINS + FX.ARB_ACEI + DG.CKD"
model<-glm(formu,data = dades, family = "binomial") 

model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Death or AICU",
                                        p.style = "numeric_stars")



```

## OPTION 1 results of stepwise multivariable analysis on subgroups with complete data for all variables just using death as the outcome.DM2 (n=402)

- Model 1: Death ~ ACE-I + Statin + Age.At.Admission + Sex + MacrovascularD 
- Model 2: Death ~ ACE-I + Statin + Age.At.Admission + Sex + MacrovascularD + Hypertension 
- Model 3: Death ~ ACE-I + Statin + Age.At.Admission + Sex + MacrovascularD + Hypertension + CKD
- Model 4 (UK only) Death ~ ACE-I + Statin + Age.At.Admission +  Sex  +MacrovascularD + Hypertension +  CKD Ethnic_group + MicrovascularD

```{r, include=TRUE}


c("model1b","model2b","model3b") %>% 
  map(~formula.text(.x,"Death2",a=c("FX.ARB_ACEI","FX.STATINS"),taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Model 1", "Model 2","Model 3"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


```

# 3. Analisis d'associació amb Mortalitat i Mortalitat/UCI.DM2(n=402)

## 3.1. Estimació d'OR ajustats mitjançant models de regressió logistica.DM2 (n=402)

- Toda la población 
- Evaluar DM versus no DM

```{r, include=TRUE}

model<-
  formula.text("ajuste13b", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Death or AICU models (Modelo completo)",
                                        p.style = "numeric_stars")
model<-
  formula.text("ajuste13b", "Death2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Mortality models (Modelo completo)",
                                        p.style = "numeric_stars")


```

```{r resultats1, include=FALSE}
#GRUP_DIABETIC_CAT2		Diabetes_Category	Diabetes_Category( DM2+ADO)
#
#ia)
#
#formula_i<-formula.text("Taula00C",y="FX.NO_ARB_ACEI_STATINS",taulavariables = conductor,dt=dades)

#descrTable(formula_i,method =1,
#           data=dades,
#           max.xlev = 100, 
#           show.p.overall=TRUE,
#           show.n = T,
#           hide.no="No",
#           simplify=F) %>% 
#  export2md(caption="**TABLA 3a.Característiques de les persones incloses en el conjunt de dades Covid-19 a la ONADA 1: data 01.01.2020 - 30.06.2020.Sense ARB / ACEI / ESTATINES **")
#
#iia)
#formula_ii<-formula.text("Taula00C",y="FX.STATINS2",taulavariables = conductor,dt=dades)
#descrTable(formula_ii,method =1,
#           data=dades,
#           max.xlev = 100, 
#           show.p.overall=TRUE,
#           show.n = T,
#           hide.no="No",
#           simplify=F) %>% 
#  export2md(caption="**TABLA 3b.Característiques de les persones incloses en el conjunt de dades Covid-19 a la ONADA 1: data 01.01.2020 - 30.06.2020.Només ESTATINES **")

#
#iiia)
#formula_iii<-formula.text("Taula00C",y="FX.ARB_ACEI",taulavariables = conductor,dt=dades)
#descrTable(formula_iii,method =1,
#           data=dades,
#           max.xlev = 100, 
#           show.p.overall=TRUE,
#           show.n = T,
#           hide.no="No",
#           simplify=F) %>% 
#   export2md(caption="**TABLA 3c.Característiques de les persones incloses en el conjunt de dades Covid-19 a la ONADA 1: data 01.01.2020 - 30.06.2020.Només ACEI o ARB **")
#
#iva)
#formula_iv<-formula.text("Taula00C",y="FX.ARB_ACEI_STATINS",taulavariables = conductor,dt=dades)
#descrTable(formula_iv,method =1,
#          data=dades,
#           max.xlev = 100, 
#           show.p.overall=TRUE,
#           show.n = T,
#           hide.no="No",
#           simplify=F) %>% 
# export2md(caption="**TABLA 3d.Característiques de les persones incloses en el conjunt de dades Covidien-19 ONADA 1:data 01.01.2020 - 30.06.2020.(ACEI o ARB) i ESTATINES **")


```

```{r resultats2, include=FALSE}

## 5.Modelos descriptivos

#i) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]
#ii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Diabetes)[5]+(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]

#iii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]
#iv) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Diabetes)[6]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]


#c("ajuste13b") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")


#c("ajuste13b") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13"),
#                    title = "Death y/o UCI  models",
#                    p.style = "numeric_stars")

```


```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


