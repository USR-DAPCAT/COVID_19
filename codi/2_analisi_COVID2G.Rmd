---
title: "Associations of macrovascular complications with death in patients with diabetes hospitalized for coronavirus disease-2019 (COVID-19)"
subtitle: 'The first wave of the COVID-19: date 01.01.2020 – 30.06.2020 '
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# Estat:


#### Latest updates:

September / 2021

&check; Generate new variable combined drugs  <br/>
&check; Reclassify DM2 / Types of Diabetes, and G_DIABETIC by Background, ADO and Hba1c Drugs  <br/>
&check; Descriptive report + models <br/>
&check; Descriptive analysis DM1 + DM2 (n = 406) for the articles; <br/>


October / 2021

&check; Model1:Death  ~ Macrovascular disease (unadjusted) <br/>
&check; Model2:Death  ~ Macrovascular disease + Age + Sex <br/>
&check; Model3:Death  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease <br/>
&check; Model1:ICU admission  ~ Macrovascular disease (unadjusted) <br/>
&check; Model2:ICU admission  ~ Macrovascular disease + Age + Sex <br/>
&check; Model3:ICU admission  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease <br/>
&check; Model1:Death/ ICU admission   ~ Macrovascular disease (unadjusted) <br/>
&check; Model2:Death/ ICU admission   ~ Macrovascular disease + Age + Sex <br/>
&check; Model3:Death/ ICU admission :ICU admission  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease <br/>


- Pending: 

Review and debugging


# Analysis

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")


#Associations of macrovascular complications with death in patients with diabetes

#hospitalized for coronavirus disease-2019 (COVID-19)

#Aim: To assess whether the presence of macrovascular complications (ischemic heart disease,
#stroke, peripheral artery disease) are associated with mortality and severity outcomes in
#subjects with diabetes mellitus (DM) hospitalized for COVID-19 in a European multicenter
#observational study.

#Exposure variables: The presence of macrovascular complications will be defined according to
#the presence of a previous history of ischemic heart disease (including history of myocardial
#infarction or heart failure), cerebrovascular disease (including history of stroke or transient
#ischemic attack - TIA-) and/or peripheral artery disease. Data will be processed as defined for
#each database of this collaborative proposal.

#Definition of the outcomes:
#Primary endpoint: in-hospital mortality.
#Secondary outcomes: length of hospital stay, intensive care unit (ICU) admission and
#use of invasive mechanical ventilation (IMV) on admission.




#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#18.08.2021
#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")

##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

# source(here::here("codi/Flowchart_Box_Final2.r"))
# source(here::here("codi/criteris_exclusio_diagrama2.r"))


```


```{r lectura, include = FALSE}

#canviat 10.V.2021!

load(here::here("COVID2c.Rdata"))

```



```{r preparacio, include=T}

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.STATINS2=ifelse(FX.STATINS=="Yes" ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI_STATINS=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") & (FX.STATINS=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.NO_ARB_ACEI_STATINS=ifelse( FX.ARB=="No" & FX.ACEI=="No" & FX.STATINS=="No" ,"Si","No"))


TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(UCI_DIAS.ICU2=ifelse(UCI_DIAS.ICU_DAYS>=0,1,0)) 
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate_at(vars(starts_with("UCI_DIAS.ICU2") ),funs(ifelse(is.na(.),"No","Yes")))


```

```{r, include=TRUE}

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar(taulavariables=conductor,camp_descripcio="descripcio2")

```

## GLOBAL exploratory analysis (N = 2308)

### Generate group of excluding drugs and verification

```{r, include=TRUE}
vars_fx<-c("FX.ACEI","FX.STATINS","FX.ARB")
TAULA_PLANA_exc<- TAULA_PLANA_exc %>% tidyr::unite(FX.ACEI_STATINS_ARB,vars_fx,sep="_",remove = F) 


# Capturar variable combinada d'aquests farmacs excloents
popa<-read_conductor(conductor,sheet="COMBI_FARMACOS") %>% dplyr::select(FX.ACEI_STATINS_ARB,FX.COMBI)

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  left_join(popa,by="FX.ACEI_STATINS_ARB")
# Etiquetar valors
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar_valors(variables_factors = conductor,fulla = "COMBI_FARMACOS",camp_etiqueta = "Descripcio")

# Taula de verificació
#descrTable(FX.COMBI ~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB + FX.ARB_ACEI, data= TAULA_PLANA_exc, method = 3, show.p.overall = F) %>% export2md()


rm(popa)

```

### Reclassification of type 2, type 1 and other diabetes and classification verification 

```{r, include=TRUE}



# Recalcular DM2 en funció de Diagnostic, tractament ADO o basal_HBA1C>=6.5  SENSE QUE SIGUI DM1
# GRUP_DM2 ---> DG.DM2, | FX.ADO | basal_HBA1C>=6.5 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate (GRUP_DM2=case_when(
                                                  DG.DM1=="No" & (DG.DM2=="Yes" | FX.ADO=="Yes") ~ "Yes",
                                                  DG.DM1=="Yes" & FX.ADO=="Yes" ~ "Yes",
                                                  DG.DM1=="No" & basal_pacient_valor_HBA1C_>=6.5 ~ "Yes",
                                                  TRUE ~ "No") ) 
# Reclassificar tipus de diabetis 
TAULA_PLANA_exc<-
  TAULA_PLANA_exc %>% mutate(GRUP_DIABETIC_CAT2=case_when(GRUP_DM2=="Yes"~ "2.DM2",
                                                        DG.DM1=="Yes"~"1.DM1",
                                                        DG.DM_SEC=="Yes" & GRUP_DM2=="No" & DG.DM1=="No" ~"3.Others DM",
                                                        TRUE ~ "0.No Diabetes")) 

# Reclassificar altres tipus de DM en funció de GLUCOSA BASAL>=200 O qualsevol tipus de DM, INSULINAS
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  mutate(GRUP_DIABETIC_CAT2=case_when(GRUP_DIABETIC_CAT2=="0.No Diabetes" 
                                      & (FX.INSULINAS_INTM=="Yes" | FX.INSULINAS_LENT=="Yes" | FX.INSULINAS_Rap=="Yes" | GLU_1>=200)  ~ "3.Others DM", 
                                        TRUE ~ GRUP_DIABETIC_CAT2 ))


# Reclassificar variable G_DIABETIC 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate(G_DIABETIC=if_else(GRUP_DIABETIC_CAT2=="0.No Diabetes","No","Yes"))

# Verificar tema 
#descrTable(GRUP_DM2~DG.DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
#           data=TAULA_PLANA_exc, 
#           method = 2, Q1=0,Q3=1,
#           show.p.overall = F, show.n = T) %>% export2md()


# Verificar tema 
#descrTable(G_DIABETIC ~ GRUP_DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
#           data=TAULA_PLANA_exc, 
#           method = 2, Q1=0,Q3=1,
#           show.p.overall = F, show.n = T) %>% export2md()

# Verificar tema 
descrTable(G_DIABETIC ~ GRUP_DIABETIC_CAT2,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()

# Reclassificar altres DM en funció de GLUCOSA BASAL>=200 O qualsevol tipus de DM, INSULINAS
#descrTable(GRUP_DIABETIC_CAT2 ~ G_DIABETIC + FX.INSULINAS_INTM + FX.INSULINAS_LENT +FX.INSULINAS_Rap + FX.ADO + GLU_1 + basal_pacient_valor_HBA1C_,
#           data=TAULA_PLANA_exc, 
#           method = 2, Q1=0,Q3=1,
#           show.p.overall = F, show.n = T) %>% export2md()


```

# 1.General Description [DM1 + DM2] (n = 406)

```{r res0,include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)


# FILTREM només per DM2+DM1, per equiperar-ho als articles internacionals.




TAULA_PLANA_exc<-TAULA_PLANA_exc%>% mutate(GRUP_DIABETIC_CAT3=case_when(GRUP_DIABETIC_CAT2=="0.No Diabetes"~"0.No Diabetes",
                                                                        GRUP_DIABETIC_CAT2=="1.DM1"~"2.DM1",
                                                                        GRUP_DIABETIC_CAT2=="2.DM2"~"1.DM2",
                                                                        GRUP_DIABETIC_CAT2=="3.Others DM"~"3.Others DM"))


#table(TAULA_PLANA_exc$GRUP_DIABETIC_CAT2,TAULA_PLANA_exc$GRUP_DIABETIC_CAT3)

dades<-TAULA_PLANA_exc%>% filter(GRUP_DIABETIC_CAT2=="2.DM2" | GRUP_DIABETIC_CAT2=="1.DM1")




#0.No Diabetes         1.DM1         2.DM2   3.Others DM 
#         1730             4           402           172 


#
#UCI_DIAS.ICU_DAYS

#kk<-dades%>%select(PATIENT.ID,UCI_DIAS.ICU_DAYS,Ad_UCI)




#dades$GRUP_DIABETIC_CAT2

formula1<-formula.text("Taula08b",y="",taulavariables = conductor,dt=dades)
formula2<-formula.text("Taula08b",y="DG2.MACRO",taulavariables = conductor,dt=dades)
formula2b<-formula.text("Taula08b",y="DG.MACR",taulavariables = conductor,dt=dades)

formula3<-formula.text("Taula08c",y="",taulavariables = conductor,dt=dades)
formula4<-formula.text("Taula08c",y="DG2.MACRO",taulavariables = conductor,dt=dades)
formula4b<-formula.text("Taula08c",y="DG.MACR",taulavariables = conductor,dt=dades)


descrTable(formula1,method =1,
           data=dades,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F,show.all = T) %>% 
  export2md(caption="Characteristics of people with complete data for macrovascular complications")
#


#descrTable(formula4,method =1,
#           data=dades,
#           max.xlev = 100, 
#           show.p.overall=TRUE,
#           show.n = T,
#           hide.no="No",
#           simplify=F,show.all = T) %>% 
#  export2md(caption="Table 1.Clinical characteristics of subjects according to macrovascular status(complete data)")

descrTable(formula4b,method =1,
           data=dades,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F,show.all = T) %>% 
  export2md(caption="Table 1.Clinical characteristics of subjects according to macrovascular status(complete data) / New Macrovascular complications")

#

```
# 2. Multivariable models

## 2.1. Death Multivariable analysis on subgroup with complete data for all variables.Estimation of crude and adjusted ORs using Logistic Regression models (DM1+DM2,n=406)

>  Model1:Death ~ Macrovascular disease (unadjusted),     
   Model2:Death ~ Macrovascular disease + Age + Sex,     
   Model3:Death ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease 

```{r res1,include=TRUE, warning=F}




#c("ajuste15a1","ajuste15a2","ajuste15a3") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality models (unadjusted)", "Mortality models (adjusted)","Mortality models (adjusted)"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")


#print("without Grup_diabetic_cat ")



#c("ajuste15a1","ajuste15a2","ajuste15a4") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality models (unadjusted)", "Mortality models (adjusted)","Mortality models (adjusted)"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")



print("New Macrovascular complications  Models ")



#c("ajuste15b1","ajuste15b2","ajuste15b3") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality Models (unadjusted)", "Mortality Models (adjusted)","Mortality models (adjusted)"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")


#print("without Grup_diabetic_cat ")



c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality Models (unadjusted)", "Mortality Models (adjusted)","Mortality mMdels (adjusted)"),
                    title = "Mortality models",
                    p.style = "numeric_stars")

##############
#[10.11.2021]#
##############

c("ajuste16a","ajuste16b","ajuste16c") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality Models (unadjusted)", "Mortality Models (adjusted)","Mortality mMdels (adjusted)"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


c("ajuste16d","ajuste16e","ajuste16f") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality Models (unadjusted)", "Mortality Models (adjusted)","Mortality mMdels (adjusted)"),
                    title = "Mortality models",
                    p.style = "numeric_stars")

c("ajuste16g","ajuste16h","ajuste16i") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Mortality Models (unadjusted)", "Mortality Models (adjusted)","Mortality mMdels (adjusted)"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


```
## 2.2. ICU admission Multivariable analysis on subgroup with complete data for all variables.Estimation of crude and adjusted ORs using Logistic Regression models (DM1+DM2,n=406)


> Model1:ICU admission  ~ Macrovascular disease (unadjusted),     
  Model2:ICU admission  ~ Macrovascular disease + Age + Sex,     
  Model3:ICU admission  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease 


```{r res2,include=TRUE, warning=F}




#18.11.2020 HO HE CANVIAT

dades$Ad_UCI2<-ifelse(dades$Ad_UCI=="Yes",1,0)


###############################################################################################
#model4<-
#  formula.text("ajuste15a1", "Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
#model4 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "ICU admission  models (unadjusted)",p.style = "numeric_stars")

#model5<-
#  formula.text("ajuste15a2", "Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
#model5 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "ICU admission  models (adjusted)",
#                                        p.style = "numeric_stars")
#
#model6<-
#  formula.text("ajuste15a3", "Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
#model6 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "ICU admission  models (adjusted)",
#                                        p.style = "numeric_stars")
###############################################################################################

#c("ajuste15a1","ajuste15a2","ajuste15a3") %>% 
#  map(~formula.text(.x,"Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("ICU admission Models (unadjusted)", "ICU admission Models (adjusted)","ICU admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



#c("ajuste15a1","ajuste15a2","ajuste15a4") %>% 
#  map(~formula.text(.x,"Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
# sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("ICU admission Models (unadjusted)", "ICU admission Models (adjusted)","ICU admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")






print("New Macrovascular complications  Models ")




#c("ajuste15b1","ajuste15b2","ajuste15b3") %>% 
#  map(~formula.text(.x,"Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("ICU admission Models (unadjusted)", "ICU admission Models (adjusted)","ICU admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
 sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("ICU admission Models (unadjusted)", "ICU admission Models (adjusted)","ICU admission models (adjusted)"),
                    title = "ICU admission  models",
                    p.style = "numeric_stars")




```
## 2.3. Use of IMV on admission Multivariable analysis on subgroup with complete data for all variables.Estimation of crude and adjusted ORs using Logistic Regression models (DM1+DM2,n=406)

> Model1:Use of IMV on admission ~ Macrovascular disease     
  Model2:Use of IMV on admission ~ Macrovascular disease + Age + Sex
  Model3:use of IMV on admission ~ Macrovascular disease + Age + Sex + Ethnic group + Type of
Diabetes + BMI + Hypertension + Dyslipidaemia + Microvascular disease 


```{r res3,include=TRUE, warning=F}


dades$EV1.Mechanical_ventialtion2<-ifelse(dades$EV1.Mechanical_ventialtion=="Yes",1,0)




#c("ajuste15a1","ajuste15a2","ajuste15a3") %>% 
#  map(~formula.text(.x,"EV1.Mechanical_ventialtion2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Use of IMV on admission Models (unadjusted)", "Use of IMV on admission Models (adjusted)","Use of IMV on admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



#c("ajuste15a1","ajuste15a2","ajuste15a4") %>% 
#  map(~formula.text(.x,"EV1.Mechanical_ventialtion2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
# sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Use of IMV on admission Models (unadjusted)", "Use of IMV on admission Models (adjusted)","Use of IMV on admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")






print("New Macrovascular complications  Models ")




#c("ajuste15b1","ajuste15b2","ajuste15b3") %>% 
#  map(~formula.text(.x,"EV1.Mechanical_ventialtion2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Use of IMV on admission Models (unadjusted)", "Use of IMV on admission Models (adjusted)","Use of IMV on admission models (adjusted)"),
#                    title = "ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"EV1.Mechanical_ventialtion2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
 sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Use of IMV on admission Models (unadjusted)", "Use of IMV on admission Models (adjusted)","Use of IMV on admission models (adjusted)"),
                    title = "ICU admission  models",
                    p.style = "numeric_stars")













```
## 2.4. Death/ ICU admission Multivariable analysis on subgroup with complete data for all variables.Estimation of crude and adjusted ORs using Logistic Regression models (DM1+DM2,n=406)


>  Model1:Death/ ICU admission   ~ Macrovascular disease (unadjusted),     
   Model2:Death/ ICU admission   ~ Macrovascular disease + Age + Sex,     
   Model3:Death/ ICU admission :ICU admission  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease 


```{r res4,include=TRUE, warning=F}


#Death_DG_Ad_UCI

###############################################################################################
#model7<-
#  formula.text("ajuste15a1", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
# model7 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "Death/ICU admission  models (unadjusted)",
#                                        p.style = "numeric_stars")
#
#model8<-
#  formula.text("ajuste15a2", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
#model8 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "Death/ICU admission  models (adjusted)",
#                                        p.style = "numeric_stars")
#
#model9<-
#  formula.text("ajuste15a3", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
#  glm(data = dades, family = "binomial")
#model9 %>% sjPlot::tab_model(digits=3, show.intercept = F,
#                    title = "Death/ICU admission  models (adjusted)",
#                                        p.style = "numeric_stars")
###############################################################################################




#c("ajuste15a1","ajuste15a2","ajuste15a3") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death/ICU admission  models (unadjusted)", "Death/ICU admission  models (adjusted)","Death/ICU admission  models (adjusted)"),
#                    title = "Death/ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



#c("ajuste15a1","ajuste15a2","ajuste15a4") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
# sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death/ICU admission  models (unadjusted)", "Death/ICU admission  models (adjusted)","Death/ICU admission  models (adjusted)"),
#                    title = "Death/ICU admission  models",
#                    p.style = "numeric_stars")




print("New Macrovascular complications  Models ")




#c("ajuste15b1","ajuste15b2","ajuste15b3") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death/ICU admission  models (unadjusted)", "Death/ICU admission  models (adjusted)","Death/ICU admission  models (adjusted)"),
#                    title = "Death/ICU admission  models",
#                    p.style = "numeric_stars")


#table(dades$GRUP_DIABETIC_CAT2,dades$Ad_UCI2)

#print("without Grup_diabetic_cat ")



c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
 sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death/ICU admission  models (unadjusted)", "Death/ICU admission  models (adjusted)","Death/ICU admission  models (adjusted)"),
                    title = "Death/ICU admission  models",
                    p.style = "numeric_stars")


```
## 2.5.  log(Length-of-stay_hosp) Multivariable analysis on subgroup with complete data for all variables.Estimation of crude and adjusted parameters using Lineal Regression models (DM1+DM2,n=406)


>  Model1:Death/ ICU admission   ~ Macrovascular disease (unadjusted),     
   Model2:Death/ ICU admission   ~ Macrovascular disease + Age + Sex,     
   Model3:Death/ ICU admission :ICU admission  ~ Macrovascular disease + Age + Sex + Ethnic group + Type of Diabetes + BMI + Hypertension + Dyslipidaemia  + Microvascular disease 

```{r res5,include=TRUE, warning=F}


dades<-dades%>% 
  mutate(temps_hosp=as.numeric(ymd(F_ALTA.DISCHARGE_DATE_ING)-ymd(F_INGRESO.ADMISSION_D_ING.INPAT))+1)

dades<-dades%>% 
  mutate(temps_hosp2=as.numeric(ymd(F_ALTA.DISCHARGE_DATE_ING)-ymd(F_INGRESO.ADMISSION_D_ING.INPAT)))


#creem el log del temps d'estancia a l'hospital!!!

dades<-dades%>% 
  mutate(log_temps_hosp=log10(temps_hosp))



#table(dades$MOTIVO_ALTA.DESTINY_DISCHARGE_ING,dades$Death2)


################################################                                  
#                                        No  Si#
################################################
#                                        9   0 #
#  Alta Voluntaria                       1   0 #
#  Domicilio                           292   0 #
#  Fallecimiento                         0  79 #
#  Traslado a un Centro Sociosanitario  16   0 #
#  Traslado al Hospital                  9   0 #
################################################

#table(dades$DG.MACR)
#table(dades$SEXO.SEX)
#table(dades$DG2.Hyperlip)
#table(dades$DG.HTA)
#table(dades$DG2.MICRO)


dades$DG.MACR2<-ifelse(dades$DG.MACR=="Yes",1,0)
dades$SEXO.SEX2<-ifelse(dades$SEXO.SEX=="MALE ",1,0)
dades$DG2.Hyperlip2<-ifelse(dades$DG2.Hyperlip=="Yes",1,0)
dades$DG.HTA2<-ifelse(dades$DG.HTA=="Yes",1,0)
dades$DG2.MICRO2<-ifelse(dades$DG2.MICRO=="Yes",1,0)

#table(dades$DG.MACR2)
#table(dades$SEXO.SEX2)
#table(dades$DG2.Hyperlip2)
#table(dades$DG.HTA2)
#table(dades$DG2.MICRO2)


LOG<-dades%>% dplyr::select(temps_hosp,log_temps_hosp,DG.MACR2,EDAD.AGE,SEXO.SEX2,DG2.Hyperlip2,DG.HTA2,DG2.MICRO2,Death2)
LOG2<-dades%>% dplyr::select(temps_hosp, log_temps_hosp,DG.MACR,EDAD.AGE,SEXO.SEX,DG2.Hyperlip,DG.HTA,DG2.MICRO,Death)

#summary(LOG)
pairs(LOG)

#c("ajuste15a1","ajuste15a2","ajuste15a4") %>% 
#  map(~formula.text(.x,"log_temps_hosp",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "gaussian")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = T,dv.labels = c("log(length-of-stay_hosp) models (unadjusted)", "log(length-of-stay_hosp)  models (adjusted)","log(length-of-stay_hosp) models (adjusted)"),
#                    title = "Log(length-of-stay_hosp) models",
#                    p.style = "numeric_stars")



print("New Macrovascular complications  Models ")




c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"log_temps_hosp",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "gaussian")) %>% 
   sjPlot::tab_model(digits=3, show.intercept = T,dv.labels = c("log(length-of-stay_hosp) models (unadjusted)", "log(length-of-stay_hosp)  models (adjusted)","log(length-of-stay_hosp) models (adjusted)"),
                    title = "Log(length-of-stay_hosp) models",
                    p.style = "numeric_stars")





###############################################################################################
model0a<-
  formula.text("ajuste15b1", "log_temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "gaussian")
###############################################################################################
###############################################################################################
model0b<-
  formula.text("ajuste15b2", "log_temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "gaussian")
###############################################################################################
###############################################################################################
model0c<-
  formula.text("ajuste15b4", "log_temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "gaussian")
###############################################################################################


#The diagnostic plots show residuals in four different ways:

#Residuals vs Fitted. Used to check the linear relationship assumptions. A horizontal line, without distinct patterns is an indication for a linear relationship, what is good.

#Normal Q-Q. Used to examine whether the residuals are normally distributed. It’s good if residuals points follow the straight dashed line.

#Scale-Location (or Spread-Location). Used to check the homogeneity of variance of the residuals (homoscedasticity). Horizontal line with equally spread points is a good indication of homoscedasticity. This is not the case in our example, where we have a heteroscedasticity problem.

#Residuals vs Leverage. Used to identify influential cases, that is extreme values that might influence the regression results when included or excluded from the analysis. This plot will be described further in the next sections.


par(mfrow = c(2, 2))
plot(model0a)

par(mfrow = c(2, 2))
plot(model0b)

par(mfrow = c(2, 2))
plot(model0c)

#####################
#E78.2--> Hyperlip
####################

#HEM de canviar el MODEL!!

print("we should make a Poisson model !")

#install.packages(NHSRdatasets)
library(NHSRdatasets)
library(dplyr)
library(ggplot2)




ggplot(dades, aes(x=EDAD.AGE)) +
  geom_histogram(alpha=0.5, col=1, fill=12, bins=20)+
  ggtitle("Distribution of Age")

ggplot(dades, aes(x=temps_hosp)) +
  geom_histogram(alpha=0.5, col=1, fill=13, bins=20)+
  ggtitle("Distribution of Length-of-Stay")




c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"temps_hosp",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "poisson")) %>% 
   sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("length-of-stay_hosp models (unadjusted)", "length-of-stay_hosp models (adjusted)","length-of-stay_hosp models (adjusted)"),
                    title = "length-of-stay_hosp models.(Poisson)",
                    p.style = "numeric_stars")



#c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
#  map(~formula.text(.x,"temps_hosp2",taulavariables = conductor,dt=dades))%>% 
#  map(~glm(.x,data = dades, family = "poisson")) %>% 
#   sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("length-of-stay_hosp models (unadjusted)", "length-of-stay_hosp models (adjusted)","length-of-stay_hosp models (adjusted)"),
#                    title = "length-of-stay_hosp models.(Poisson), with 0",
#                    p.style = "numeric_stars")




###############################################################################################
model1<-
  formula.text("ajuste15b1", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "poisson")

model2<-
  formula.text("ajuste15b2", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "poisson")


model3<-
  formula.text("ajuste15b4", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "poisson")
###############################################################################################

with(model1,cbind(res.deviance=deviance,df=df.residual,Assumption_Ho_Test_Poisson=deviance/df.residual,P=pchisq(model1$deviance, df=model1$df.residual, lower.tail=FALSE) ))
with(model2,cbind(res.deviance=deviance,df=df.residual,Assumption_Ho_Test_Poisson=deviance/df.residual,P=pchisq(model2$deviance, df=model2$df.residual, lower.tail=FALSE) ))
with(model3,cbind(res.deviance=deviance,df=df.residual,Assumption_Ho_Test_Poisson=deviance/df.residual,P=pchisq(model3$deviance, df=model3$df.residual, lower.tail=FALSE) ))

###############################################################################################

print("The Poisson distribution is characterized because its expectation and its variance coincide; when a Poisson model is fitted to a data set it can happen that both values different significantly. The model is then said to be over-scattered. In the AER package of R there is a test that allows to contrast the presence of over-dispersion in a model. In our example the result of this test is:")

library(AER)

dispersiontest(model1)
dispersiontest(model2)
dispersiontest(model3)


print("The models cannot be applied a poisson model,we finally apply a negative binomial model")


# library(MASS) 


# Librería que contiene el procedimiento para la regresión BN
#modBN <- glm.nb(Recuento~Temperatura+Humedad,data=parasitos)
#summary(modBN)





c("ajuste15b1","ajuste15b2","ajuste15b4") %>% 
  map(~formula.text(.x,"temps_hosp",taulavariables = conductor,dt=dades))%>% 
  map(~ MASS::glm.nb(.x,data = dades)) %>% 
   sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("length-of-stay_hosp models (unadjusted)", "length-of-stay_hosp models (adjusted)","length-of-stay_hosp models (adjusted)"),
                    title = "length-of-stay_hosp models.(Negative Binomial)",
                    p.style = "numeric_stars")




model1_nb<-
  formula.text("ajuste15b1", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  MASS::glm.nb(data = dades)

model2_nb<-
  formula.text("ajuste15b2", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  MASS::glm.nb(data = dades)


model3_nb<-
  formula.text("ajuste15b4", "temps_hosp",taulavariables = conductor,dt=dades) %>% 
  MASS::glm.nb(data = dades)


#summary(model1_nb)
#summary(model2_nb)
#summary(model3_nb)


pchisq(model1_nb$deviance, df=model1_nb$df.residual, lower.tail=FALSE)
pchisq(model2_nb$deviance, df=model2_nb$df.residual, lower.tail=FALSE)
pchisq(model3_nb$deviance, df=model3_nb$df.residual, lower.tail=FALSE)



print("Saw this test, we can apply the negative binomial model")



```



## 4. ANNEX: Macrovascular Complications Codes 

```{r codis_MACRO, include=T}


readxl::read_excel(conductor_codis2,col_types = "text")%>%dplyr::select(cod,Descripcio,agr,agr0,agr2)%>% filter(agr0=="MACR")%>%dplyr::select(cod,agr0,agr)%>% knitr::kable(caption="ICD10 Macrovascular Complications Codes ")



```




```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


