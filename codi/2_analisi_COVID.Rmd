---
title: "Impacto de la  diabetes mellitus en personas hospitalizadas por COVID19"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# 0. Estado:

> Des / 2020


Eventos:

&check; Traducir al inglés los gáficos para el artículo a través del Conductor <br/>



> Nov / 2020


Eventos:

&check; Hacer Modelos con interacciones y recalcular modelos con orden de variables <br/>
&check; Añadir complicaciones neurológicas <br/>
&check; Tabla estratificado por sexo para pacientes no diabéticos <br/>
&check; Quitar los fármacos de los modelos <br/>
&check; Arreglar la tabla de laboratorio añadiendo [stringsAsFactors=F] <br/>
&check; Las curvas spline con los nuevos datos <br/>
&check; Añadidos modelos no paramétricos para estudiar efecto no lineal  <br/>
&check; Graficar Splines de glucosa de modelos finales <br/>



**Últimas actualizaciones** 

**Realizado**

> Febrero/2021

&check; Mejora de los modelos no paramétricos con término spline(Glucosa)  <br/>

> Setiembre/2020

&check; Ampliar tablas descriptivas P25, Median , P75 etc.. <br/>
&check; Cálculo de nuevas variable IFCC HBA1C, agrupador Comp_cardiovascular <br/>
&check; Calcular y añadir p valores en tabla 2 <br/>
&check; Actualizaciones modelos de mortalidad modelo definitivo <br/>
&check; actualizaciones nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Modelos por subgrupos <br/>
&check; Forest plot de modelos <br/>


> Agost/2020

&check; Nuevos modelos de mortalidad  <br/>
&check; Nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Comprobar valores de máximos de glucosa basal. <br/>

> Agost/2020

&check; Revisar código (Split script & Review)  <br/>
&check; Canvi de criteri de DM a: HB>=6.5 y/o Glucemia >=200 <br/>
&check; Generar tabla plana <br/>
&check; Nuevos modelos de mortalidad <br/>
&check; Nuevos modelos de ingreso en UCI <br/>

> Juliol/2020

&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Mortalidad <br/>

>

&check; Lectura / importación de archivos  <br/>
&check; Generación de conductors   <br/>
&check; Revisión de códigos  <br/>
&check; Agregación de datos segun protocolo <br/>
&check; Cálculo de varibles y recodificaciones <br/>
&check; Descriptiva exploratoria <br/>
&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Moeratlidad <br/>

**Pendent**

* Revisión y depuración d'errors 

# Análisis

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")



##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

#source(here::here("codi/Flowchart_Box_Final2.r"))
#source(here::here("codi/criteris_exclusio_diagrama2.r"))


# Llanço taula i camp que vull etiquetar i cambia nom del camp en funció d'etiqueta

etiquetar_taula<-function(taula=resumtotal,camp="variable",taulavariables="variables_R.xls",camp_descripcio="descripcio2",idcamp="camp") {
  
  # taula=porca
  # taulavariables=conductor
  # camp="Parameter"
  # camp_descripcio="desc_model"
  # idcamp="camp2"

  ####  Llegir etiquetes i variables a analitzar ####
  variables <- read_conductor(taulavariables)
  camp_sym<-sym(camp)
  idcamp_sym<-sym(camp_sym)

  # Canviar nom de camp de variables al de la taula 
  # colnames(variables)[colnames(variables)=="camp"] <- camp
  colnames(variables)[colnames(variables)==idcamp] <- camp

  # Canviar arguments per ser evaluats
  camp_eval<-sym(camp)
  camp_descripcio_eval<-sym(camp_descripcio)
  # Canviar el format de la taula 
  taula %>% left_join(dplyr::select(variables,c(!!camp_eval,camp_descripcio)),by=quo_name(camp_eval)) %>% 
    rename(descripcio=!!camp_descripcio) %>% 
    mutate(!!camp_eval:=descripcio) %>% 
    dplyr::select(-descripcio)
 
}

# Cambia nom dels elements d'un vector 



#--------------------------------------------------------------------#
test_HL<-function(model){
  
  
  pp<-hoslem.test(model$y, fitted(model))
  round(pp$p.value,2)  
  
  }
#--------------------------------------------------------------------#



```


```{r lectura, include = FALSE}

load(here::here("COVID1.Rdata"))

```



```{r recodes1}


TAULA_PLANA<-TAULA_PLANA%>%mutate(GLU_MAX=DM.GLU_MAX)

#Hem canviat el Yes!
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DG.") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DG2.") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("FX.") ),funs(ifelse(is.na(.),"No","Yes")))

TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("CVD.") ),funs(ifelse(is.na(.),"No","Yes")))

#29.3.2021

TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM1") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM2") ),funs(ifelse(is.na(.),"No","Yes")))


TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM_P") ),funs(ifelse(is.na(.),0,1)))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM_F") ),funs(ifelse(is.na(.),0,1)))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM.GLI") ),funs(ifelse(is.na(.),0,1)))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM.INSU") ),funs(ifelse(is.na(.),0,1)))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("DM.GLU_MAX") ),funs(ifelse(is.na(.),0,1)))



table(TAULA_PLANA$DM_P.DM)
table(TAULA_PLANA$DM_F.DM)
table(TAULA_PLANA$DM.GLI)
table(TAULA_PLANA$DM.INSU)
table(TAULA_PLANA$DM.GLU_MAX)





#DM-article

TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("GR1") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("GR2") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("GR3") ),funs(ifelse(is.na(.),"No","Yes")))

#DM-Didac!

#max_pacient_valor_GLU_>=200

TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("GRUP_A") ),funs(ifelse(is.na(.) ,"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("GRUP_B") ),funs(ifelse(is.na(.) ,"No","Yes")))

table(TAULA_PLANA$G_DIABETIC)
table(TAULA_PLANA$GRUP_A)
table(TAULA_PLANA$GRUP_B)

# canvi 18.5.2021

table(TAULA_PLANA$GRUP_B)

#GRUP_A<-dt_plana_DM_agr1%>%
#  bind_rows(dt_plana_DM_agr2)%>%
#  bind_rows(dt_plana_DM_agr3)%>%
#  arrange(idp)%>%
#  group_by(idp)%>% slice(1) %>% ungroup() %>%dplyr::select(idp)%>%mutate(GRUP_A=1)

#GRUP_B<-dt_plana_DM_agr5%>%
#  bind_rows(dt_plana_DM_agr4)%>%
#  arrange(idp)%>%
#  group_by(idp)%>% slice(1) %>% ungroup() %>%dplyr::select(idp)%>%mutate(GRUP_B=1)

table(TAULA_PLANA$DM_P.DM)
table(TAULA_PLANA$DM_F.DM)
table(TAULA_PLANA$DM.GLI)
table(TAULA_PLANA$DM.INSU)
table(TAULA_PLANA$DM.GLU_MAX)

TAULA_PLANA$GRUP_A<-ifelse( (TAULA_PLANA$DM_P.DM==1  | TAULA_PLANA$DM_F.DM==1  | TAULA_PLANA$DM.GLI==1 )  
                            & (TAULA_PLANA$DM.INSU==0)  & (TAULA_PLANA$DM.GLU_MAX==0), "Si","No") 
                           
                            
TAULA_PLANA$GRUP_B<-ifelse((TAULA_PLANA$DM.INSU==1  | TAULA_PLANA$DM.GLU_MAX==1   )  
                            & (TAULA_PLANA$DM_P.DM==0)  & (TAULA_PLANA$DM_F.DM==0) & (TAULA_PLANA$DM.GLI==0)  , "Si","No") 
                            






#  mutate(
#    type = case_when(
#      height > 200 | mass > 200 ~ "large",
#      species == "Droid"        ~ "robot",
#      TRUE                      ~  "other"
#    )
#  )


#TAULA_PLANA$GRUP_C <- NULL 
#TAULA_PLANA$GRUP_D <- NULL 
#TAULA_PLANA$GRUP_E <- NULL 


#TAULA_PLANA<-TAULA_PLANA%>%mutate(
#            GRUP_C=case_when(
#            ((DM_P.DM==1 | DM_F.DM==1 | DM.GLI==1) &  DM.INSU==0 & DM.GLU_MAX==0) ~"Grupo_DM_Far_Glic",
#            ((DM_P.DM==0 & DM_F.DM==0 & DM.GLI==0) & (DM.INSU==1 | DM.GLU_MAX==1)) ~"Grupo_Insul_Glu_max",
#            (DM_P.DM==1 | DM_F.DM==1 | DM.GLI==1 |  DM.INSU==1 | DM.GLU_MAX==1) ~"Altres_Dm",
#            TRUE~  "No Dm"))


TAULA_PLANA<-TAULA_PLANA%>%mutate(
                  GRUP_D=case_when(
                  ((DM_P.DM==1 | DM_F.DM==1 | DM.GLI==1)) ~"Grupo DM+Far+Glic",
                  (is.na(G_DIABETIC)) ~"Grupo No DM",
                  TRUE             ~  "Grupo  No DM+Far+Glic"))


TAULA_PLANA<-TAULA_PLANA%>%mutate(
                  GRUP_E=case_when(
                  ((DM_P.DM==0 & DM_F.DM==0 & DM.GLI==0) & (DM.INSU==1 | DM.GLU_MAX==1)) ~"Grupo Stress hiperglicemia",
                  (is.na(G_DIABETIC)) ~"Grupo No DM",
                  TRUE~  "Grupo No Stress hiperglicemia"))

TAULA_PLANA<-TAULA_PLANA%>%mutate(
                  GRUP_F=case_when(
                  ((DM.INSU==1 | DM.GLU_MAX==1)) ~"Grupo Stress hiperglicemia",
                  (is.na(G_DIABETIC)) ~"Grupo No DM",
                  TRUE~  "Grupo No Stress hiperglicemia"))


TAULA_PLANA<-TAULA_PLANA%>%mutate(
                  GRUP_G=case_when(
                  ((DM_P.DM==1 | DM_F.DM==1 | DM.GLI==1)) ~"Grupo DM+Far+Glic",
                  ((DM_P.DM==0 & DM_F.DM==0 & DM.GLI==0) & (DM.INSU==1 | DM.GLU_MAX==1)) ~"Grupo Stress hiperglicemia",
                  (is.na(G_DIABETIC)) ~"Grupo No DM"))
                  
DT_TEMP<-TAULA_PLANA%>%dplyr::select(PATIENT.ID,DM_P.DM,DM_F.DM,DM.GLI,DM.INSU,DM.GLU_MAX,GRUP_D,GRUP_E,GRUP_F,G_DIABETIC)


#table(TAULA_PLANA$DM_P.DM)
#table(TAULA_PLANA$DM_F.DM)
#table(TAULA_PLANA$DM.GLI)
#table(TAULA_PLANA$DM.INSU)
#table(TAULA_PLANA$DM.GLU_MAX)
#table(TAULA_PLANA$GRUP_D)
#table(TAULA_PLANA$GRUP_E)
#table(TAULA_PLANA$GRUP_F)

#table(TAULA_PLANA$GRUP_C)
#table(TAULA_PLANA$GRUP_D)
#table(TAULA_PLANA$GRUP_E)

#Gracias Ray, 
#creo que no te llego el comentario de Google doc, pero, lo que decía Didac es crear 2 grupos:

#Punto 1.

#solo habrá que tener 2 grupos:  

#Un grupo de preexisting diabetes que incluye: 
# sujetos con código diagnostico de DM y/o tratamiento y/o glicada (HbA1C=>6.5) 

#Grupo con stress hiperglicemia, 
#que incluye  los pacientes con serum glucose en inclusion >=200 y /o inslulin en primeros 24 h ,

#Ojo: excluyendo los sujetos con código diagnostico de DM y/o tratamiento y/o glicada (HbA1C=>6.5)

#Tienen que ser excluyentes y sumar el numero total que tenemos de DM ahora 448


#table(TAULA_PLANA$GRUP_D,TAULA_PLANA$GRUP_E)
#                       
#                        Grupo No DM Grupo No Stress hiperglicemia Grupo Stress hiperglicemia
#  Grupo  No DM+Far+Glic           0                             0                        150
#  Grupo DM+Far+Glic               0                           332                          0
#  Grupo No DM                  1824                             0                          0
##################################################



```


```{r recodes2}

TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("EV1.") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("EV2.") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("EV3.") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("G_DIABETIC") ),funs(ifelse(is.na(.),"No","Yes")))
TAULA_PLANA<-TAULA_PLANA%>%mutate_at(vars(starts_with("Neurologic_Comp") ),funs(ifelse(is.na(.),"No","Yes")))

```


```{r preparacio1, include = FALSE}

TAULA_PLANA<-TAULA_PLANA%>%mutate(exclusio1=ifelse(DIAG.ING.INPAT=="COVID19 - POSITIVO",0,1))
TAULA_PLANA<-TAULA_PLANA%>%mutate(exclusio2=ifelse(EDAD.AGE>18,0,1)) 

TAULA_PLANA$Ad_UCI<-ifelse(is.na(TAULA_PLANA$F_ENTRADA_UC.ICU_DATE_IN),"No","Yes" )
TAULA_PLANA$EDAD.AGE2<- ifelse(TAULA_PLANA$EDAD.AGE<=65,"<=65 años",">65 años")
TAULA_PLANA$EDAD.AGE3<- ifelse(TAULA_PLANA$EDAD.AGE<=55,"<=55 años",">55 años")
TAULA_PLANA$Death<- ifelse(TAULA_PLANA$MOTIVO_ALTA.DESTINY_DISCHARGE_ING=="Fallecimiento","Yes","No")

#PROVA!!

TAULA_PLANA$agecat2<-9999
TAULA_PLANA$agecat2<-ifelse(TAULA_PLANA$EDAD.AGE<40,"0",TAULA_PLANA$agecat2)
TAULA_PLANA$agecat2<-ifelse(TAULA_PLANA$EDAD.AGE>=40 & TAULA_PLANA$EDAD.AGE<=60,"1",TAULA_PLANA$agecat2)
TAULA_PLANA$agecat2<-ifelse(TAULA_PLANA$EDAD.AGE>=61,"2",TAULA_PLANA$agecat2)
#



#table(TAULA_PLANA$agecat2)



```


## 1.Flow Chart

```{r flow_chart, include = TRUE,message = FALSE,warning = FALSE,echo = FALSE}
#flow chartS : eps m'ha fallat!!! 


criteris_exclusio_diagrama(dt=TAULA_PLANA,
                                        taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups=NA,
                                        etiquetes="descripcio2",
                                        sequencial = T,
                                        pob_lab=c("Covid Data Save Lives","Muestra con Covid positivo"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))



#criteris_exclusio_diagrama2(dt=TAULA_PLANA,
#                                        taulavariables=conductor,
#                                        criteris = "exc_pre",
#                                        ordre="exc_ordre",
#                                        grups=NA,
#                                        etiquetes="descripcio",
#                                        sequencial = T,
#                                        pob_lab=c("Covid Data Save Lives","Muestra con Covid positivo"),
#                                        colors=c("grey","white"),
#                                        POB=459331 ,
#                                        POB_LAB="SIDIAP:La población de pacientes con DM2 de 2017 aprox: ")
##################################3




criteris_exclusio_diagrama(dt=TAULA_PLANA,
                                      taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups="G_DIABETIC",
                                        etiquetes="descripcio2",
                                        sequencial = T,
                                        pob_lab=c("Covid Data Save Lives","Muestra con Covid positivo"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))



#criteris_exclusio_diagrama2(dt=TAULA_PLANA,
#                                        taulavariables=conductor,
#                                        criteris = "exc_pre",
#                                        ordre="exc_ordre",
#                                        grups="G_DIABETIC",
#                                        etiquetes="descripcio2",
#                                        sequencial = T,
#                                        pob_lab=c("Covid Data Save Lives","Muestra con Covid positivo"),
#                                        colors=c("white","grey"),
#                                        POB=2306 ,
#                                        POB_LAB="Covid Data Save Lives ")

# prova!

#criteris_exclusio_diagrama2(dt=TAULA_PLANA,
#                                        taulavariables=conductor,
#                                        criteris = "exc_pre",
#                                        ordre="exc_ordre",
#                                        grups="agecat2",
#                                        etiquetes="descripcio",
#                                        sequencial = T,
#                                        pob_lab=c("Covid Data Save Lives","Muestra con Covid positivo"),
#                                        colors=c("white","grey"),
#                                        POB=2306 ,
#                                        POB_LAB="Covid Data Save Lives ")




```


```{r preparacio3, include = FALSE}

TAULA_PLANA_exc<-criteris_exclusio(TAULA_PLANA,taulavariables=conductor,criteris="exc_pre")

DT_TEMP2<-TAULA_PLANA_exc%>%dplyr::select(PATIENT.ID,DM.GLU_MAX,GRUP_G,DM_P.DM,DM_F.DM,DM.INSU,GLU_MAX)

#Glicemia >550!

table(DT_TEMP2$GLU_MAX)



DT_TEMP2$GRUP_550<-ifelse(DT_TEMP2$GLU_MAX<=550 |  is.na(DT_TEMP2$GLU_MAX),0,1)

table(DT_TEMP2$GLU_MAX)
table(DT_TEMP2$GRUP_550,DT_TEMP2$GRUP_G)

########################################################################################
# Grupo                        DM+Far+Glic Grupo No DM Grupo Stress hiperglicemia
#  Glicemia <=550 OR Na         301        1621             145
#  Glicemia >550                 1           0               1
#########################################################################################

# els màxims valors:

# 516   
# 531   
# 538 
# 550.9 
# 686.9 



#dt_plana_DM_agr5<-dt_plana_DM_agr5%>% filter(max_pacient_valor_GLU_>=200 )


#prova:
#temp<-TAULA_PLANA_exc%>%filter(GRUP_B=="Yes")%>%dplyr::select(PATIENT.ID,GRUP_B,max_pacient_valor_GLU_,DM_P.DM,DM_F.DM)

#table(TAULA_PLANA_exc$DM1.E10)
#table(TAULA_PLANA_exc$DM2.E11)

```


```{r preparacio4, include = FALSE}


TAULA_PLANA_exc<-TAULA_PLANA_exc%>%
  mutate(Death_DG.Mechanical_ventialtion = ifelse(Death == "Yes"| EV1.Mechanical_ventialtion=="Yes" , "Yes", "No"))

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%
  mutate(Death_DG.Mechanical_ventialtion_Ad_UCI = ifelse(Death == "Yes"| EV1.Mechanical_ventialtion=="Yes" | Ad_UCI=="Yes", "Yes", "No"))

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%
  mutate(DG.Mechanical_ventialtion_Ad_UCI = ifelse(EV1.Mechanical_ventialtion=="Yes" | Ad_UCI=="Yes", "Yes", "No"))



```


```{r preparacio5, include = FALSE}

TAULA_PLANA_exc$agecat<-9999

TAULA_PLANA_exc$agecat<-ifelse(TAULA_PLANA_exc$EDAD.AGE<20,"0",TAULA_PLANA_exc$agecat)
TAULA_PLANA_exc$agecat<-ifelse(TAULA_PLANA_exc$EDAD.AGE>=20 & TAULA_PLANA_exc$EDAD.AGE<=39
                                               ,"1",TAULA_PLANA_exc$agecat)

TAULA_PLANA_exc$agecat<-ifelse(TAULA_PLANA_exc$EDAD.AGE>=40 & TAULA_PLANA_exc$EDAD.AGE<=59
                                             ,"2",TAULA_PLANA_exc$agecat)

TAULA_PLANA_exc$agecat<-ifelse(TAULA_PLANA_exc$EDAD.AGE>59,"3",TAULA_PLANA_exc$agecat)

TAULA_PLANA_exc$Death2<-ifelse(TAULA_PLANA_exc$Death=="Yes",1,0)

#18.11.2020 HO HE CANVIAT
#TAULA_PLANA_exc$Ad_UCI<-ifelse(TAULA_PLANA_exc$Ad_UCI=="Si",1,0)






```


```{r preparacio6, include=FALSE}

#mirar-ho!! ull parlar amb en Jordi tema etiquetar variables i etiquetar valors?

## Factoritzar
TAULA_PLANA_exc<-TAULA_PLANA_exc%>% mutate_at(extreure.variables("factor",conductor,dt=TAULA_PLANA_exc),as.factor)

## Reetiquetar
TAULA_PLANA_exc<-etiquetar(TAULA_PLANA_exc,taulavariables=conductor, camp_descripcio = "descripcio2")

#07.12.2020
#TAULA_PLANA_exc<-etiquetar_valors(dt=TAULA_PLANA_exc,variables_factors=conductor,fulla="etiquetes",camp_etiqueta="etiqueta1")


TAULA_PLANA_exc_DIAB<-TAULA_PLANA_exc%>%filter(G_DIABETIC=="Yes")
TAULA_PLANA_exc_NO_DIAB<-TAULA_PLANA_exc%>%filter(G_DIABETIC=="No")



TAULA_PLANA_exc<-TAULA_PLANA_exc%>% mutate(GRUP_DIABETIC_CAT=case_when(GRUP_DIABETIC_CAT==0~"No Diabetes",GRUP_DIABETIC_CAT==1~"DM1",GRUP_DIABETIC_CAT==2~"DM2",GRUP_DIABETIC_CAT==3~"Others DM"))






```


## 2.Descriptivo general


```{r resultats1, include=T}


hist(DT_TEMP2$GLU_MAX,
     main="Distribucion de los valores de la Glicemia Max",
     xlab="Valor max de la Glicemia   ",
     ylab="Frecuencia ",
     col="green",
     freq=T,
     xlim=c(120,700) ,
     ylim=c(0,25) ,
     breaks = 100,
         )


#CVD#

formula<-formula.text("CVD",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc) 
descrTable(formula,method =2,
           Q1 = 0.25, Q3 = 0.75,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           show.all=T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA CVD.**")

#---------------------------------------#
CVD<-CVD%>% mutate(PATIENT.ID=idp)
CVD$PATIENT.ID<-as.double(CVD$PATIENT.ID)
CVD2<-TAULA_PLANA_exc%>%dplyr::select(PATIENT.ID)
CVD2<- CVD2%>%left_join(CVD,by="PATIENT.ID")
#---------------------------------------#
#frq(CVD2$cod_CVD)
#---------------------------------------#



DIAB_GRUP<-  G_DIABETIC~GRUP_DIABETIC_CAT


descrTable(DIAB_GRUP,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           show.all=T,
           simplify=F) %>% 
  export2md(caption="TABLA 0. Type of DIABETES.")




formula<-formula.text("Taula01",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc) 
descrTable(formula,method =2,
           Q1 = 0.25, Q3 = 0.75,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           show.all=T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 1a. Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso,  si ha habido, datos del paso por UCI, si ha habido.Todos los pacientes.**")

#############################################
#formula,method =2 (No Paramètric/No normal)#
#############################################


# formula<-formula_table1("Taula01",y="DIAB",taulavariables = conductor,dt=dt_plana_covid1_agr_exc_lab) 
table1::table1(~EDAD.AGE|G_DIABETIC, 
               data = TAULA_PLANA_exc,overall="Total",caption="Taula 1a",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"))

# Genero filtre dades solament urgencies
TAULA_PLANA_exc2<-TAULA_PLANA_exc%>%filter(URG=="Yes")

formula<-formula.text("Taula01B",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc2) 

descrTable(formula,
                 method =2,
                 Q1 = 0, Q3 = 1,
                 data=TAULA_PLANA_exc2,
                 max.xlev = 100, 
                 show.p.overall=FALSE,
                 show.n = T,
                 show.all=T,
                 hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 1b. Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")


table1::table1(~EDAD.AGE|G_DIABETIC, 
               data = TAULA_PLANA_exc2,caption="Taula 1b",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"))


# Fer-ho!  12.05.2021

#formula1<-formula.text("Taula01B",y="GR1",taulavariables = conductor,dt=TAULA_PLANA_exc2) 
#formula2<-formula.text("Taula01B",y="GR2",taulavariables = conductor,dt=TAULA_PLANA_exc2) 
#formula3<-formula.text("Taula01B",y="GR3",taulavariables = conductor,dt=TAULA_PLANA_exc2) 

#formula4<-formula.text("Taula01B",y="GRUP_A",taulavariables = conductor,dt=TAULA_PLANA_exc2) 
#formula5<-formula.text("Taula01B",y="GRUP_B",taulavariables = conductor,dt=TAULA_PLANA_exc2) 


#descrTable(formula1,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc2,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 1c.DM Problemas de salut+Fármacos DM: Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")


#descrTable(formula2,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc2,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 1d.DM tengan Hemoglobina Glicosilada >=6.5 : Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")


#descrTable(formula3,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc2,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 1e.DM administrados Insulina +Glucosa Màxima>=200 : Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")



#descrTable(formula4,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc2,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 1f.DM Problema de salud+DM Fármaco+Hemoglobina Glicosilada>=6.5+DM administrados Insulina  : Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")


#descrTable(formula5,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc2,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 1g.Glucosa Màxima>=200  : Registros de pacientes ingresados: Demográficos, datos del episodio del ingreso, datos del episodio de urgencias previo, si ha habido, datos del paso por UCI, si ha habido.SOLO URGENCIAS.**")

```
### 2.1 Descriptiva  Problemas de salud
```{r resultats2, include=T}

#mirar-ho aqui!


#table(TAULA_PLANA_exc$DM1.E10)
#table(TAULA_PLANA_exc$DM2.E11)

formula<-formula.text("Taula05",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,
                method =2,
                Q1 = 0, Q3 = 1,
                data=TAULA_PLANA_exc,
                max.xlev = 100, 
                show.p.overall=TRUE,
                show.n = T,
                show.all=T,
                hide.no="No",simplify=F) %>% 
  export2md(caption="**Tabla 2a. Registros de la codificación de la urgencia e  ingreso según la CIE10.Todos los pacientes.**") 



formula<-formula.text("Taula05B",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,
                method =2,
                Q1 = 0, Q3 = 1,
                data=TAULA_PLANA_exc,
                max.xlev = 100, 
                show.p.overall=TRUE,
                show.n = T,
                show.all=T,
                hide.no="No",simplify=F) %>% 
  export2md(caption="**Tabla 2b. Registros de la codificación de la urgencia e  ingreso según la CIE10.Todos los pacientes.**") 



```
### 2.2 Descriptiva  Constantes Vitales
```{r resultats3, include=T}


formula<-formula.text("Taula03",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,
                 method =2,
                 Q1 = 0, Q3 = 1,
                 data=TAULA_PLANA_exc,
                 max.xlev = 100, 
                 show.p.overall=TRUE,
                 show.n = T,
                 show.all=T,
                 hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 3.Registros de las constantes vitales  durante el ingreso(no se recogen las de UCI),con la función!.**")


formula<-formula_table1("Taula03",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc) 
table1::table1(formula, 
               data = TAULA_PLANA_exc,caption="**TABLA 3.Registros de las constantes vitales  durante el ingreso(no se recogen las de UCI),con la función!.**",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"))




```
### 2.3 Descriptiva  Laboratorio
```{r resultats4, include=T}

formula<-formula.text("Taula04",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,
                method =2,
                Q1 = 0, Q3 = 1,
                data=TAULA_PLANA_exc,
                max.xlev = 100, 
                show.p.overall=TRUE,
                show.n = T,
                show.all=T,
                hide.no="No",simplify=F,digits = 2) %>% 
  export2md(caption="**TABLA 4. Registros de los resultados de peticiones de laboratorio realizadas durante el ingreso,con la función!.**")



formula<-formula_table1("Taula04",y="G_DIABETIC",taulavariables = conductor,dt=TAULA_PLANA_exc) 
table1::table1(formula, 
               data = TAULA_PLANA_exc,caption="**TABLA 4. Registros de los resultados de peticiones de laboratorio realizadas durante el ingreso,con la función!.**",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"))



```
### 2.4 Descriptiva  Medicamentos
```{r resultats5, include=T}

formula<-formula.text("Taula02",y="G_DIABETIC",taulavariables = conductor,dt = TAULA_PLANA_exc )

descrTable(formula,
                method =2,
                Q1 = 0, Q3 = 1,
                data=TAULA_PLANA_exc,
                max.xlev = 100, 
                show.p.overall=TRUE,
                show.n = T,
                show.all=T,
                hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 5a. Registros de la medicacion pautada y administrada durante el ingreso (no se recoge la medicación de UCI).**")



formula<-formula.text("Taula02B",y="G_DIABETIC",taulavariables = conductor,dt = TAULA_PLANA_exc)

descrTable(formula,
                method =2,
                Q1 = 0, Q3 = 1,
                data=TAULA_PLANA_exc,
                max.xlev = 100, 
                show.p.overall=TRUE,
                show.n = T,
                show.all=T,
                hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 5b. Registros de la medicacion pautada y administrada durante el ingreso (no se recoge la medicación de UCI).**")




```
### 2.5 Descriptiva  EVENTOS
```{r resultats6, include=T}


#i)   Death, n (%)
#ii)  Death and/or invasive mechanical ventilation, n (%),
#iii) Invasive mechanical ventilation, n (%),
#iv)  Pulmonary embolism 
#v)   ARDS, n (%),
#vi)  Thrombotic complications n (%),
#vii) Neurologic complications, n (%)
#viii)Admission to ICU, n (%),
#ix)  Days in ICU, (min,max), 




#TAULA_PLANA_exc_DIAB
#TAULA_PLANA_exc_NO_DIAB

formula<-formula.text("Taula08",y="G_DIABETIC",taulavariables = conductor,dt = TAULA_PLANA_exc)

descrTable(formula,  
                         method =2,
                         Q1 = 0, Q3 = 1,
                         data=TAULA_PLANA_exc,
                         max.xlev = 100, 
                         show.p.overall=TRUE,
                         show.n = T,
                         show.all=T,
                         hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6i.Eventos y complicaciones  en pacientes diabéticos i no diabéticos **")




formula1<-formula.text("Taula08",y="GR1",taulavariables = conductor,dt=TAULA_PLANA_exc) 
formula2<-formula.text("Taula08",y="GR2",taulavariables = conductor,dt=TAULA_PLANA_exc) 
formula3<-formula.text("Taula08",y="GR3",taulavariables = conductor,dt=TAULA_PLANA_exc) 

formula4<-formula.text("Taula08",y="GRUP_A",taulavariables = conductor,dt=TAULA_PLANA_exc) 
formula5<-formula.text("Taula08",y="GRUP_B",taulavariables = conductor,dt=TAULA_PLANA_exc) 

formula6<-formula.text("Taula08",y="GRUP_D",taulavariables = conductor,dt=TAULA_PLANA_exc) 
formula7<-formula.text("Taula08",y="GRUP_E",taulavariables = conductor,dt=TAULA_PLANA_exc) 

formula8<-formula.text("Taula08",y="GRUP_G",taulavariables = conductor,dt=TAULA_PLANA_exc) 


# Taules Article!:

#descrTable(formula1,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 6i.Eventos y complicaciones.DM Problemas de salut+Fármacos DM.**")


#descrTable(formula2,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 6ii.Eventos y complicaciones.DM tengan Hemoglobina Glicosilada >=6.5.**")


#descrTable(formula3,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 6iii.Eventos y complicaciones.DM administrados Insulina +Glucosa Màxima>=200.**")


# Taules Didac:




#descrTable(formula6,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#               hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 6ii.Eventos y complicaciones.DM Problema de salud+DM Fármaco+Hemoglobina Glicosilada>=6.5.**")
#
#
#descrTable(formula7,
#                 method =2,
#                 Q1 = 0, Q3 = 1,
#                 data=TAULA_PLANA_exc,
#                 max.xlev = 100, 
#                 show.p.overall=FALSE,
#                 show.n = T,
#                 hide.no="No",simplify=F) %>% 
#  export2md(caption="**TABLA 6iii.Eventos y complicaciones.Stress hiperglicemia.**")
#
#########################################################################################################################


descrTable(formula8,
                 method =2,
                 Q1 = 0, Q3 = 1,
                 data=TAULA_PLANA_exc,
                 max.xlev = 100, 
                 show.p.overall=FALSE,
                 show.n = T,
                 show.all=T,
                 hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6i.Eventos y complicaciones.DM Problema de salud+DM Fármaco+Hemoglobina Glicosilada>=6.5.Stress hiperglicemia.**")




#########################################################################################################################

formula<-formula.text("Taula08",y="SEXO.SEX",taulavariables = conductor,dt = TAULA_PLANA_exc_DIAB)
descrTable(formula,
                         method =2,
                         Q1 = 0, Q3 = 1,
                         data=TAULA_PLANA_exc_DIAB,
                         max.xlev = 100, 
                         show.p.overall=TRUE,
                         show.n = T,
                         show.all=T,
                         hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6a. Eventos y complicaciones  en pacientes diabéticos+Sexo **")



formula<-formula.text("Taula08",y="SEXO.SEX",taulavariables = conductor,dt = TAULA_PLANA_exc_NO_DIAB)
descrTable(formula,
                         method =2,
                         Q1 = 0, Q3 = 1,
                         data=TAULA_PLANA_exc_NO_DIAB,
                         max.xlev = 100, 
                         show.p.overall=TRUE,
                         show.n = T,
                         show.all=T,
                         hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6b. Eventos y complicaciones  en pacientes No diabéticos+Sexo **")







formula<-formula.text("Taula08",y="EDAD.AGE2",taulavariables = conductor,dt = TAULA_PLANA_exc_DIAB)
descrTable(formula,                            
                         method =2,
                         Q1 = 0, Q3 = 1,
                         data=TAULA_PLANA_exc_DIAB,
                         max.xlev = 100, 
                         show.p.overall=TRUE,
                         show.n = T,
                         show.all=T,
                         hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6b. Eventos y complicaciones  en pacientes diabéticos <=65 años, > 65 años **")




formula<-formula.text("Taula08",y="EDAD.AGE2",taulavariables = conductor,dt = TAULA_PLANA_exc_NO_DIAB)

descrTable(formula,       
                         method =2,
                         Q1 = 0, Q3 = 1,
                         data=TAULA_PLANA_exc_NO_DIAB,
                         max.xlev = 100, 
                         show.p.overall=TRUE,
                         show.n = T,
                         show.all=T,
                         hide.no="No",simplify=F) %>% 
  export2md(caption="**TABLA 6d. Eventos y complicaciones  en pacientes no diabéticos <=65 años, > 65 años **")





```

## 3. Modelos multivariables

### 3.1 Modelos de Mortalidad y de mal pronostico (VM o muerte) población total
```{r resultats7, include=T, warning=F}

#M1.M2.M3.  [Diabetes (yes)]
#M1.M2.M3.  [Age (years)]
#M1.M2.M3.  [Sex (male)]
#M2.M3.     [Obesity (yes)]
#M2.M3.     [Hypertension (yes)]
#M2.M3.     [Hyperlipidaemia (yes)]
#M3.        [COPD (yes)]
#M3.        [Heart failure (yes)] 
#M3.        [Chronic renal insufficiency (yes)]
#M3.        [Cardiovascular diseases (yes)]


#M4.M5.M6.  [Serum glucose]  
#M4.M5.M6.  [Age (years)]
#M4.M5.M6.  [Sex (male)]
#M5.M6.     [Obesity (yes)]
#M5.M6.     [Hypertension (yes)]
#M5.M6.     [Hyperlipidaemia (yes)]
#M6.        [COPD (yes)]
#M6.        [Heart failure (yes)] 
#M6.        [Chronic renal insufficiency (yes)]
#M6.        [Cardiovascular diseases (yes)]

#"Death2 ~ G_DIABETIC + EDAD.AGE + SEXO.SEX + DG2.OB + DG2.HTA + DG2.Hyperlip"

#table(TAULA_PLANA_exc$Death2)
#table(TAULA_PLANA_exc$G_DIABETIC)
#table(TAULA_PLANA_exc$EDAD.AGE)
#table(TAULA_PLANA_exc$SEXO.SEX)
#table(TAULA_PLANA_exc$DG2.OB)
#table(TAULA_PLANA_exc$DG2.HTA)
#table(TAULA_PLANA_exc$DG2.Hyperlip)



c("ajuste1","ajuste2","ajuste3") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M1", "M2","M3"),
                    title = "Mortality models",
                    p.style = "numeric_stars")

#hoslem.test(TAULA_PLANA_exc$Death2, fitted(k1))

library(rcompanion)
library(lmtest)
library(ResourceSelection) 
library("kableExtra")

#https://rcompanion.org/rcompanion/e_06.html

ajuste_A<-c("ajuste1","ajuste2","ajuste3") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial"))


names(ajuste_A)<-c(" M1 "," M2 "," M3 ")
map_df(ajuste_A,~test_HL(.x)) %>% kable(caption = "The Hosmer–Lemeshow test P-Value")%>%
kable_styling(bootstrap_options = "striped", font_size = 12)




c("ajuste4","ajuste5","ajuste6") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M4", "M5","M6"),
                    title = "Mortality models",
                    p.style = "numeric_stars")

ajuste_B<-c("ajuste4","ajuste5","ajuste6") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) 

?test_HL


names(ajuste_B)<-c(" M4 "," M5 "," M6 ")
map_df(ajuste_B,~test_HL(.x)) %>% kable(caption = "The Hosmer–Lemeshow test P-Value")%>%
kable_styling(bootstrap_options = "striped", font_size = 12)


```



```{r resultats7.1, include=T, warning=F}
# *Muerte y/o Ventilación mecánica*

c("ajuste1","ajuste2","ajuste3") %>% 
  map(~formula.text(.x,"Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M1", "M2","M3"),
                    title = "Death or Invasive mechanical ventilation models",
                    p.style = "numeric_stars")


ajuste_C<-c("ajuste1","ajuste2","ajuste3") %>% 
  map(~formula.text(.x,"Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial"))



names(ajuste_C)<-c(" M1 "," M2 "," M3 ")
map_df(ajuste_C,~test_HL(.x))%>% kable(caption = "The Hosmer–Lemeshow test P-Value")%>%
kable_styling(bootstrap_options = "striped", font_size = 12)


c("ajuste4","ajuste5","ajuste6") %>% 
  map(~formula.text(.x,"Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M4", "M5","M6"),
                    title = "Death or Invasive mechanical ventilation models",
                    p.style = "numeric_stars")

ajuste_D<-c("ajuste4","ajuste5","ajuste6") %>% 
  map(~formula.text(.x,"Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial"))


names(ajuste_D)<-c(" M4 "," M5 "," M6 ")
map_df(ajuste_D,~test_HL(.x))%>% kable(caption = "The Hosmer–Lemeshow test P-Value")%>%
kable_styling(bootstrap_options = "striped", font_size = 12)



```

### 3.2 Modelos finales de Mortalidad población total 

```{r resultats7.2, include=T, warning=F}


#Diabetes (yes)
#Sex (male)
#Age (years)
#Obesity (yes)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)

M1_Exitus<-formula.text("ajuste7","Death2",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

M2_VM<-formula.text("ajuste7","Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

list(M1_Exitus,M2_VM) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death", "Death or Invasive mechanical ventilation"),
                    title = "Mortality models",
                    p.style = "numeric_stars") 

 list(M1_Exitus,M2_VM) %>% 
  sjPlot::plot_models(prefix.labels = "label",show.p = T,m.labels = c("Death", "Death or Invasive mechanical ventilation"))

 
	
 
ajuste_E<-formula.text("ajuste7","Death2",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 
test_HL(ajuste_E)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Death.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)

ajuste_F<-formula.text("ajuste7","Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% glm(data = TAULA_PLANA_exc, family = "binomial") 
test_HL(ajuste_F)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Death or Invasive mechanical ventilation.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)

 
 
 
# I N T E R E C C I O N E S:[]
 
#Supplementary table 3. 4 Mortality Model evaluating Diabetes and Obesity interactions
# 
#Diabetes (yes)
#Obesity (yes)
#Sex (male)
#Age (years)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)
#Diabetes (yes): Obesity (yes)

 
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#fer-ho!!!!!:[]
#formula.text("ajuste8","Death2",a="G_DIABETIC*DG.IRC")
 
 
################################################################################################ 
# M1_Exitus_INTERECCIONS1<-glm(Death2 ~ G_DIABETIC +
#          DG2.OB+ 
#          SEXO.SEX + 
#          EDAD.AGE  + 
#          DG2.HTA + 
#          DG2.Hyperlip + 
#          DG2.COMP_CARDIOVASC + 
#          DG.INSUF_CARD + 
#          DG.IRC + 
#          DG.EPOC_ENFISEMA+G_DIABETIC*DG2.OB,family = "binomial", data = TAULA_PLANA_exc)
################################################################################################  
 
 
 M1_Exitus_INTERECCIONS1<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG2.OB",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

list(M1_Exitus_INTERECCIONS1) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes and Obesity interactions",
                    p.style = "numeric_stars") 
 
 
 
ajuste_G<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG2.OB",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

test_HL(ajuste_G)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes and Obesity interactions.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)



#Supplementary table 3. 5 Mortality Model evaluating Diabetes and Hyperlipidemia interactions
#
#Diabetes (yes)
#Hyperlipidaemia (yes)
#Sex (male)
#Age (years)
#Obesity (yes)
#Hypertension (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)
#Diabetes (yes): Hyperlipidaemia (yes)



# M1_Exitus_INTERECCIONS2<-glm(Death2 ~ G_DIABETIC +
#          DG2.OB+ 
#          SEXO.SEX + 
#          EDAD.AGE  + 
#          DG2.HTA + 
#          DG2.Hyperlip + 
#          DG2.COMP_CARDIOVASC + 
#          DG.INSUF_CARD + 
#          DG.IRC + 
#          DG.EPOC_ENFISEMA+G_DIABETIC*DG2.Hyperlip,family = "binomial", data = #TAULA_PLANA_exc)

M1_Exitus_INTERECCIONS2<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG2.Hyperlip",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

list(M1_Exitus_INTERECCIONS2) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes and Hyperlipidemia interactions",
                    p.style = "numeric_stars") 



 
ajuste_H<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG2.Hyperlip",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 


test_HL(ajuste_H)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes and Hyperlipidemia interactions.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)


 
#Supplementary table 3. 6 Mortality Model evaluating Diabetes and Heart failure interactions 
#
#Predictors
#Diabetes (yes)
#Heart failure (yes)
#Sex (male)
#Age (years)
#Obesity (yes)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)
#Diabetes (yes): Heart failure (yes)


#M1_Exitus_INTERECCIONS3<-glm(Death2 ~ G_DIABETIC +
#          DG2.OB+ 
#          SEXO.SEX + 
#          EDAD.AGE  + 
#          DG2.HTA + 
#          DG2.Hyperlip + 
#          DG2.COMP_CARDIOVASC + 
#          DG.INSUF_CARD + 
#          DG.IRC + 
#          DG.EPOC_ENFISEMA+G_DIABETIC*DG.INSUF_CARD,family = "binomial", data = #TAULA_PLANA_exc)

M1_Exitus_INTERECCIONS3<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG.INSUF_CARD",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

 
list(M1_Exitus_INTERECCIONS3) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes and Heart failure interactions",
                    p.style = "numeric_stars") 



test_HL(M1_Exitus_INTERECCIONS3)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes and Heart failure interactions.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)



#Supplementary table 3. 7 Mortality Model evaluating Diabetes, obesity and hyperlipidemia interactions
#   
#Diabetes (yes)
#Obesity (yes)
#Hyperlipidaemia (yes)
#Sex (male)
#Age (years)
#Hypertension (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)
#Diabetes (yes): Obesity (yes)
#Diabetes (yes): Hyperlipidaemia (yes)


M1_Exitus_INTERECCIONS4<-glm(Death2 ~ G_DIABETIC +
          DG2.OB+ 
          SEXO.SEX + 
          EDAD.AGE  + 
          DG2.HTA + 
          DG2.Hyperlip + 
          DG2.COMP_CARDIOVASC + 
          DG.INSUF_CARD + 
          DG.IRC + 
          DG.EPOC_ENFISEMA+
          G_DIABETIC*DG2.OB+
          G_DIABETIC*DG2.Hyperlip,
          family = "binomial", data = TAULA_PLANA_exc)
 

list(M1_Exitus_INTERECCIONS4) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes, obesity and hyperlipidemia interactions",
                    p.style = "numeric_stars") 



test_HL(M1_Exitus_INTERECCIONS4)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes, obesity and hyperlipidemia interactions.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)




# Supplementary table 3. 8 Mortality Model evaluating Diabetes, and chronic renal insufficiency
#
#Diabetes (yes)
#Chronic renal insufficiency (yes)
#Sex (male)
#Age (years)
#Obesity (yes)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#COPD (yes)
#Diabetes (yes): Chronic renal insufficiency (yes)



#M1_Exitus_INTERECCIONS5<-glm(Death2 ~ G_DIABETIC +
#          DG2.OB+ 
#          SEXO.SEX + 
#          EDAD.AGE  + 
#          DG2.HTA + 
#          DG2.Hyperlip + 
#          DG2.COMP_CARDIOVASC + 
#          DG.INSUF_CARD + 
#          DG.IRC + 
#          DG.EPOC_ENFISEMA+G_DIABETIC*DG.IRC,family = "binomial", data = TAULA_PLANA_exc)
######################################

M1_Exitus_INTERECCIONS5<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG.IRC",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

list(M1_Exitus_INTERECCIONS5) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes, and chronic renal insufficiency",
                    p.style = "numeric_stars") 



test_HL(M1_Exitus_INTERECCIONS5)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes, and chronic renal insufficiency.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)


 
#Supplementary table 3. 9 Mortality Model evaluating Diabetes, and COPD
#
#Diabetes (yes)
#COPD (yes)
#Sex (male)
#Age (years)
#Obesity (yes)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#Diabetes (yes): COPD (yes)
 

#M1_Exitus_INTERECCIONS6<-glm(Death2 ~ G_DIABETIC +
#          DG2.OB+ 
#          SEXO.SEX + 
#          EDAD.AGE  + 
#          DG2.HTA + 
#          DG2.Hyperlip + 
#          DG2.COMP_CARDIOVASC + 
#          DG.INSUF_CARD + 
#          DG.IRC + 
#          DG.EPOC_ENFISEMA+G_DIABETIC*DG.EPOC_ENFISEMA,family = "binomial", data = TAULA_PLANA_exc)

M1_Exitus_INTERECCIONS6<-formula.text("ajuste7","Death2",a="G_DIABETIC*DG.EPOC_ENFISEMA",taulavariables = conductor,dt=TAULA_PLANA_exc)%>% 
  glm(data = TAULA_PLANA_exc, family = "binomial") 

 
list(M1_Exitus_INTERECCIONS6) %>%  
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Death"),
                    title = "Mortality model evaluating diabetes, and COPD",
                    p.style = "numeric_stars") 

  


test_HL(M1_Exitus_INTERECCIONS6)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality model evaluating diabetes, and COPD.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)

  

```




### 3.4 Modelos de mortalidad en población Diabética y no diabética 

> Análisis por subgrupos

```{r resultats9, include=T, warning=F}

#Supplementary table 5.1 
#Clinical characteristics at baseline associated to in-hospital death stratified for diabetes status

#Sex (male)
#Age 
#Obesity (yes)
#Hypertension (yes)
#Hyperlipidaemia (yes)
#Cardiovascular diseases (yes)
#Heart failure (yes)
#Chronic renal insufficiency (yes)
#COPD (yes)

#Mortality Model evaluating Diabetes and Obesity interactions


formu<-formula.text("ajuste8","Death2",taulavariables = conductor)

split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial")) %>%
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Without diabetes", "Diabetes"),
                    title = "Mortality odds ratio model evaluating  with diabetes and without diabetes",
                    p.style = "numeric_stars")


split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial")) %>%
  sjPlot::plot_models(prefix.labels = "label", 
                      legend.title = "Subgroup",
                      title = "Mortality odds ratio model evaluating  with diabetes and without diabetes",
                      m.labels = c("Without diabetes", "Diabetes"))


kkk<-split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial"))
kkk1<-kkk$Yes
kkk2<-kkk$No 

test_HL(kkk1)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality odds ratio model evaluating  with diabetes.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)

test_HL(kkk2)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality odds ratio model evaluating  with without diabetes.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)




```


### 3.5 Modelos de mortalidad o ventilación mecanica por subgrupos Diabetica y no Diabetica 

> Analisis por subgrupos

```{r resultats10, include=T, warning=F}

formu<-formula.text("ajuste8","Death_DG.Mechanical_ventialtion=='Yes'",taulavariables = conductor)

#Death or Invasive mechanical ventilation Mortality Model evaluating Diabetes

split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial")) %>%
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("Without diabetes", "Diabetes"),
                    title = "Mortality  or Invasive mechanical ventilation  odds ratio model evaluating  with diabetes and without diabetes",
                    p.style = "numeric_stars")


split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial")) %>%
  sjPlot::plot_models(prefix.labels = "label", 
                      legend.title = "Subgroup",
                      title = "Mortality  or Invasive mechanical ventilation  odds ratio model evaluating  with diabetes and without diabetes",
                      m.labels = c("Without diabetes", "Diabetes"))




kkkk<-split(TAULA_PLANA_exc,TAULA_PLANA_exc$DG2.DM) %>% 
  map(~glm(formu,data=.x,family = "binomial"))
kkkk1<-kkkk$Yes
kkkk2<-kkkk$No 

test_HL(kkkk1)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality  or Invasive mechanical ventilation  odds ratio model evaluating  with diabetes.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)

test_HL(kkkk2)%>% kable(caption = "The Hosmer–Lemeshow test P-Value.Mortality  or Invasive mechanical ventilation  odds ratio model evaluating  with without diabetes.",col.names=c("P-Value"))%>%
kable_styling(bootstrap_options = "striped", font_size = 12)



```

# Modelos no parametricos

### 3.6 Modelo no paramétricos con término spline(Glucosa) de mortalidad población total 

```{r resultats11, include=T, warning=F}
formu<-
  formula.text("ajuste8","Death2",a="s(max_pacient_valor_GLU_,k=5)",eliminar=c("max_pacient_valor_GLU_","G_DIABETIC"),taulavariables = conductor,dt=TAULA_PLANA_exc)

mod.gam.spline<-
  mgcv::gam(as.formula(formu), data = TAULA_PLANA_exc, family=binomial("logit"))

mod.gam.spline %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,title = "Mortality model with glucose spline term", p.style = "numeric_stars")

############################## ############################## ##############################
#https://www.cienciadedatos.net/documentos/32_metodos_de_regresion_no_lineal_polinomica_splines_gams
#https://github.com/tidyverse/ggplot2/issues/2907
############################## ############################## ##############################


mgcViz::getViz(mod.gam.spline) %>% 
  plot.gamViz() +
  labs(title = "Association of glucose versus mortality")+
  l_fitLine(linetype = 1)  +
  l_ciLine(linetype = 3) +
  l_rug() +
  theme_grey() +
  ylab("Logit")+xlab("Glucose") # Canvi d'escala

sjPlot::plot_model(mod.gam.spline,type="pred",terms = c("max_pacient_valor_GLU_"))+
  xlab("Glucose (mg/dL)")
  
  

#scale_y_continuous(trans='exp',labels=function(x) round(exp(x),1)) +  # Canvi d'escala
#In self$trans$inverse(limits) : NaNs produced


```




### 3.8  Modelo no paramétrico con término spline (Glucosa) de mortalidad y/o ventilación mecánica población total 

```{r resultats12, include=T, warning=F}

TAULA_PLANA_exc <- TAULA_PLANA_exc %>%  mutate(Death_DG.Mechanical_ventialtion.2=as.numeric(Death_DG.Mechanical_ventialtion=="Yes"))

# Modelos no parametricos
formu<-formula.text("ajuste8","Death_DG.Mechanical_ventialtion.2",a="s(max_pacient_valor_GLU_,k=5)",eliminar=c("max_pacient_valor_GLU_","G_DIABETIC"),taulavariables = conductor,dt=TAULA_PLANA_exc)


mod.gam.spline<-
  mgcv::gam(as.formula(formu), data = TAULA_PLANA_exc, family=binomial("logit"))

#Mortality model with Glucose spline term
mod.gam.spline %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,title = "Mortality or Invasive mechanical ventilation  model with glucose spline term", p.style = "numeric_stars")

mgcViz::getViz(mod.gam.spline) %>% 
  plot.gamViz() +
  labs(title = "Association of Glucose versus mortality or VM")+
  l_fitLine(linetype = 1)  +
  l_ciLine(linetype = 3) +
  l_rug() +
  theme_grey() +ylab("Logit")+xlab("Glucose (mg/dL)") # Canvi d'escala

#scale_y_continuous(trans='exp',labels=function(x) round(exp(x),1)) +  # Canvi d'escala

sjPlot::plot_model(mod.gam.spline,type="pred",terms = c("max_pacient_valor_GLU_"))+
  ggplot2::ggtitle("Predicted values of Death or mechanical ventilation")+
  ylab("Death or mechanical ventilation")+
  xlab("Glucose (mg/dL)")
  



```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


