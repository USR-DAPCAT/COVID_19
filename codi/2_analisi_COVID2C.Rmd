---
title: "Impacto de la  diabetes mellitus en personas hospitalizadas por COVID19."
subtitle: 'OLA 1: data 01.01.2020 – 30.06.2020 '
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# Estado:


#### Últimas actualizaciones:

Julio /2021

&check; Generar variable nova farmacs combinats  <br/>
&check; Reclasificar DM2 / Tipus de diabetis, i G_DIABETIC en funció de Antecedents, fàrmacs ADO i Hba1c  <br/>
&check; Refer descriptiva + models <br/>
&check; Separa analisis en 2 poblacions: 1. Global i 2 DM2 versus Pob no DM; <br/>

- Pendinte: 

Revisión y depuración 

# Análisis

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")

##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

# source(here::here("codi/Flowchart_Box_Final2.r"))
# source(here::here("codi/criteris_exclusio_diagrama2.r"))


```


```{r lectura, include = FALSE}

#canviat 10.V.2021!

load(here::here("COVID2c.Rdata"))


```



```{r preparacio, include=T}

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.STATINS2=ifelse(FX.STATINS=="Yes" ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI_STATINS=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") & (FX.STATINS=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.NO_ARB_ACEI_STATINS=ifelse( FX.ARB=="No" & FX.ACEI=="No" & FX.STATINS=="No" ,"Si","No"))


```

```{r, include=TRUE}

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar(taulavariables=conductor,camp_descripcio="descripcio2")

```


## Analisis exploratori

### Generar grup de fármacs excluyents i verificació 

```{r, include=TRUE}
vars_fx<-c("FX.ACEI","FX.STATINS","FX.ARB")
TAULA_PLANA_exc<- TAULA_PLANA_exc %>% tidyr::unite(FX.ACEI_STATINS_ARB,vars_fx,sep="_",remove = F) 


# Capturar variable combinada d'aquests farmacs excloents
popa<-read_conductor(conductor,sheet="COMBI_FARMACOS") %>% select(FX.ACEI_STATINS_ARB,FX.COMBI)

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  left_join(popa,by="FX.ACEI_STATINS_ARB")
# Etiquetar valors
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar_valors(variables_factors = conductor,fulla = "COMBI_FARMACOS",camp_etiqueta = "Descripcio")

# Taula de verificació
descrTable(FX.COMBI ~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB + FX.ARB_ACEI, data= TAULA_PLANA_exc, method = 3, show.p.overall = F) %>% export2md()


rm(popa)

```


### Reclasificació de Diabetis tipus 2, tipus 1 i altres i verificació de classificació 

```{r, include=TRUE}

# Recalcular DM2 en funció de Diagnostic, tractament ADO o basal_HBA1C>=6.5  SENSE QUE SIGUI DM1
# GRUP_DM2 ---> DG.DM2, | FX.ADO | basal_HBA1C>=6.5 

TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate (GRUP_DM2=case_when(
                                                  DG.DM1=="No" & (DG.DM2=="Yes" | FX.ADO=="Yes") ~ "Yes",
                                                  DG.DM1=="No" & basal_pacient_valor_HBA1C_>=6.5 ~ "Yes",
                                                  TRUE ~ "No") ) 
# Reclassificar tipus de diabetis 
TAULA_PLANA_exc<-
  TAULA_PLANA_exc %>% mutate(GRUP_DIABETIC_CAT2=case_when(GRUP_DM2=="Yes"~ "2.DM2",
                                                        DG.DM1=="Yes"~"1.DM1",
                                                        DG.DM_SEC=="Yes" & GRUP_DM2=="No" & DG.DM1=="No" ~"3.Others DM",
                                                        TRUE ~ "0.No Diabetes")) 

# Reclassificar variable G_DIABETIC 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% mutate(G_DIABETIC=if_else(GRUP_DIABETIC_CAT2=="0.No Diabetes","No","Yes"))

# Verificar tema 
descrTable(GRUP_DM2~DG.DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()


# Verificar tema 
descrTable(G_DIABETIC ~ GRUP_DM2+ FX.ADO + DG.DM1 + basal_pacient_valor_HBA1C_,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()

# Verificar tema 
descrTable(G_DIABETIC ~ GRUP_DIABETIC_CAT2,
           data=TAULA_PLANA_exc, 
           method = 2, Q1=0,Q3=1,
           show.p.overall = F, show.n = T) %>% export2md()


```


# 1. Descriptiva general i per convinació de fàrmacs

## 1.2. Descriptiva general  i per convinació de farmacs població total (n=2308)



```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc 


formula<-formula.text("Taula00C",y="FX.COMBI",taulavariables = conductor,dt=dades)

descrTable(formula,method =1,
           data=dades,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F,show.all = T) %>% 
  export2md(caption="Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. Por combinaciones de Farmacos ACE / ARB / Statins")
#


```

## 1.2. Població DM + Exclosos subjectes amb DM1 i altres tipus de DM  (N=2122): 

Población DM2 + población sense DM (N=2122)

```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc %>% filter(GRUP_DM2=="Yes" | G_DIABETIC=="No")


formula<-formula.text("Taula00C",y="FX.COMBI",taulavariables = conductor,dt=dades)

descrTable(formula,method =1,
           data=dades,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F,show.all = T) %>% 
  export2md(caption="Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. Por combinaciones de Farmacos ACE / ARB / Statins")
#

```


# 2. Analisis d'associació amb mortalitat 

## 2.1. Estimación de OR crudos y ajustados mediante modelos de regressión logistica (n=2308)

- Toda la población 
- Evaluar DM versus no DM

```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc 

formu<-formula.text("ajuste13",a=c("GRUP_DM2","GRUP_DIABETIC_CAT2"), "Death2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()

model<-
  formula.text("ajuste13",a="G_DIABETIC", "Death2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Mortality models (Modelo completo)",
                                        p.style = "numeric_stars")



```


## 2.2. Estimación de OR crudos y ajustados mediante modelos de regressión logistica (n=2122)

- Población DM2 + sin ningun tipo de diabetis conocida e identificada (N= 2122)
- Evaluar Diabetis tipo 2 versus población general

```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc %>% filter(GRUP_DM2=="Yes" | G_DIABETIC=="No")

formu<-formula.text("ajuste14",a=c("GRUP_DM2"), "Death2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()


model<-
  formula.text("ajuste14",a="GRUP_DM2", "Death2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Mortality models (Modelo completo)",
  
                                      p.style = "numeric_stars")


```

# 3. Analisis d'associació amb event combinat mortalitat/ UCI

## 3.1. Estimación de OR crudos y ajustados mediante modelos de regressión logistica (n=2308)

- Toda la población 
- Evaluar DM versus no DM

```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc 

formu<-formula.text("ajuste13",a=c("GRUP_DM2","GRUP_DIABETIC_CAT2","G_DIABETIC"), "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()


model<-
  formula.text("ajuste13",a="G_DIABETIC", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Death or AICU models (Modelo completo)",
                                        p.style = "numeric_stars")



```

## 3.2. Estimación de OR crudos y ajustados mediante modelos de regressión logistica (n=2122)

- Población DM2 + sin ningun tipo de diabetis conocida e identificada (N= 2122)
- Evaluar Diabetis tipo 2 versus población general



```{r, include=TRUE}

# Filtre: només pacients DM2 i població control sense cap tipus de DM (DM1 ni altres tipus)
dades<-TAULA_PLANA_exc %>% filter(GRUP_DM2=="Yes" | G_DIABETIC=="No")

formu<-formula.text("ajuste14",a=c("GRUP_DM2"), "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades)
descrTable(formu,data=dades,show.ratio = T, show.p.ratio = T,byrow = T) %>% export2md()


model<-
  formula.text("ajuste14",a="GRUP_DM2", "Death_DG_Ad_UCI2",taulavariables = conductor,dt=dades) %>% 
  glm(data = dades, family = "binomial")
  
model %>% sjPlot::tab_model(digits=3, show.intercept = F,
                    title = "Death or AICU model",
  
                                      p.style = "numeric_stars")


```


```{r, include=FALSE}

c("ajuste13.2","ajuste14.2") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=dades))%>% 
  map(~glm(.x,data = dades, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")

```




```{r resultats1, include=F}
#GRUP_DIABETIC_CAT2		Diabetes_Category	Diabetes_Category( DM2+ADO)

#ia)

formula_i<-formula.text("Taula00C",y="FX.NO_ARB_ACEI_STATINS",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula_i,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 3a.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Sin ARB/ACEI/ESTATINAS**")
#
#iia)
formula_ii<-formula.text("Taula00C",y="FX.STATINS2",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_ii,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 3b.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ESTATINAS**")

#
#iiia)
formula_iii<-formula.text("Taula00C",y="FX.ARB_ACEI",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_iii,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 3c.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ACEI o ARB **")
#
#iva)
formula_iv<-formula.text("Taula00C",y="FX.ARB_ACEI_STATINS",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_iv,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 3d.Características de las personas incluidas en el conjunto de datos Covidien-19 OLA 1: data 01.01.2020 – 30.06.2020.(ACEI o ARB) y ESTATINAS **")
```


```{r resultats1.2, include=F}

TAULA_PLANA_exc_b<-TAULA_PLANA_exc%>%filter(GRUP_DIABETIC_CAT!="No Diabetes")


#ib)
descrTable(formula_i,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 4a.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Sin ARB/ACEI/ESTATINAS**")
#
#iib)
descrTable(formula_ii,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 4b.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ESTATINAS**")

#
#iiib)
descrTable(formula_iii,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 4c.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ACEI o ARB **")
#
#ivb)
descrTable(formula_iv,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 4d.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covidien-19 OLA 1: data 01.01.2020 – 30.06.2020.(ACEI o ARB) y ESTATINAS **")


#part bivariada:


formula_v<-formula.text("Taula00C",y="Death",taulavariables = conductor,dt=TAULA_PLANA_exc)
formula_vi<-formula.text("Taula00C",y="Death_DG_Ad_UCI",taulavariables = conductor,dt=TAULA_PLANA_exc)


descrTable(formula_v,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 5.Mortalidad y sus Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. **")
#
#ivb)
descrTable(formula_vi,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 6.Mortalidad i/o UCI y Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. **")



```




```{r resultats2, include=F}

## 5.Modelos descriptivos

#i) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Type.Of.Diabetes)[5]+(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]
#ii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Diabetes)[5]+(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]

#iii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Type.Of.Diabetes)[6]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]
#iv) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Diabetes)[6]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]



#c("ajuste9","ajuste10") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")
#
#c("ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M11", "M12"),
#                   title = "Mortality models",
#                    p.style = "numeric_stars")
#
#
#
# abans:

#c("ajuste9","ajuste10","ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10","M11", "M12"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")


c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


#Death_DG_Ad_UCI


#c("ajuste9","ajuste10","ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10","M11", "M12"),
#                    title = "Death y/o UCI  models",
#                    p.style = "numeric_stars")


c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Death y/o UCI  models",
                    p.style = "numeric_stars")





```


```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


