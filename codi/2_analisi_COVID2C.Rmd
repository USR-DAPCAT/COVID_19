---
title: "Impacto de la  diabetes mellitus en personas hospitalizadas por COVID19."
subtitle: 'OLA 1: data 01.01.2020 – 30.06.2020 '
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****



# 0. Estado:

> Des / 2020


Eventos:

&check; Traducir al inglés los gáficos para el artículo a través del Conductor <br/>



> Nov / 2020


Eventos:

&check; Hacer Modelos con interacciones y recalcular modelos con orden de variables <br/>
&check; Añadir complicaciones neurológicas <br/>
&check; Tabla estratificado por sexo para pacientes no diabéticos <br/>
&check; Quitar los fármacos de los modelos <br/>
&check; Arreglar la tabla de laboratorio añadiendo [stringsAsFactors=F] <br/>
&check; Las curvas spline con los nuevos datos <br/>
&check; Añadidos modelos no paramétricos para estudiar efecto no lineal  <br/>
&check; Graficar Splines de glucosa de modelos finales <br/>



**Últimas actualizaciones** 

**Realizado**

> Mayo/Junio/2021

&check; Estudiar la primera ola, a partir de la ultima base de datos Julio.2020  <br/>


> Febrero/2021

&check; Mejora de los modelos no paramétricos con término spline(Glucosa)  <br/>

> Setiembre/2020

&check; Ampliar tablas descriptivas P25, Median , P75 etc.. <br/>
&check; Cálculo de nuevas variable IFCC HBA1C, agrupador Comp_cardiovascular <br/>
&check; Calcular y añadir p valores en tabla 2 <br/>
&check; Actualizaciones modelos de mortalidad modelo definitivo <br/>
&check; actualizaciones nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Modelos por subgrupos <br/>
&check; Forest plot de modelos <br/>


> Agost/2020

&check; Nuevos modelos de mortalidad  <br/>
&check; Nuevos modelos de Ventilación Mecánica y/o mortalidad <br/>
&check; Comprobar valores de máximos de glucosa basal. <br/>

> Agost/2020

&check; Revisar código (Split script & Review)  <br/>
&check; Canvi de criteri de DM a: HB>=6.5 y/o Glucemia >=200 <br/>
&check; Generar tabla plana <br/>
&check; Nuevos modelos de mortalidad <br/>
&check; Nuevos modelos de ingreso en UCI <br/>

> Juliol/2020

&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Mortalidad <br/>

>

&check; Lectura / importación de archivos  <br/>
&check; Generación de conductors   <br/>
&check; Revisión de códigos  <br/>
&check; Agregación de datos segun protocolo <br/>
&check; Cálculo de varibles y recodificaciones <br/>
&check; Descriptiva exploratoria <br/>
&check; FLOW CHARTS Criterios de Inclusión y Descriptiva GENERAL.Ingresos , Urgencías <br/>
&check; Descriptiva Problemas de salud <br/>
&check; Descriptiva Constantes Vitales <br/>
&check; Descriptiva Laboratorio <br/>
&check; Descriptiva Mediacmentos <br/>
&check; Descriptiva EVENTOS <br/>
&check; Modelos de Moeratlidad <br/>

**Pendent**

* Revisión y depuración d'errors 

# Análisis

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in #the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to #embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

#06.11.2020

############
#09.09.2020
#16.09.2020
###########

library("dplyr")
library("lubridate")
library("base")
library("frequency")
library("table1")

# load package
library("sjPlot")
library("sjmisc")
library("sjlabelled")
library("mgcViz")

##########
#6.8.2020#
##########

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)

# directori_dades<-params$dir_dades
#directori_dades<-params$dir_dades

conductor<-here::here("conductor_Covid.xlsx")
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

# source(here::here("codi/Flowchart_Box_Final2.r"))
# source(here::here("codi/criteris_exclusio_diagrama2.r"))


# Llanço taula i camp que vull etiquetar i cambia nom del camp en funció d'etiqueta

etiquetar_taula<-function(taula=resumtotal,camp="variable",taulavariables="variables_R.xls",camp_descripcio="descripcio2",idcamp="camp") {
  
  # taula=porca
  # taulavariables=conductor
  # camp="Parameter"
  # camp_descripcio="desc_model"
  # idcamp="camp2"

  ####  Llegir etiquetes i variables a analitzar ####
  variables <- read_conductor(taulavariables)
  camp_sym<-sym(camp)
  idcamp_sym<-sym(camp_sym)

  # Canviar nom de camp de variables al de la taula 
  # colnames(variables)[colnames(variables)=="camp"] <- camp
  colnames(variables)[colnames(variables)==idcamp] <- camp

  # Canviar arguments per ser evaluats
  camp_eval<-sym(camp)
  camp_descripcio_eval<-sym(camp_descripcio)
  # Canviar el format de la taula 
  taula %>% left_join(dplyr::select(variables,c(!!camp_eval,camp_descripcio)),by=quo_name(camp_eval)) %>% 
    rename(descripcio=!!camp_descripcio) %>% 
    mutate(!!camp_eval:=descripcio) %>% 
    dplyr::select(-descripcio)
 
}

# Cambia nom dels elements d'un vector 



```


```{r lectura, include = FALSE}

#canviat 10.V.2021!

load(here::here("COVID2c.Rdata"))





```


## 4.Descriptivo general


```{r preparacio, include=T}
#dubtes Bogdan!!!

#table(TAULA_PLANA_exc$FX.ADO)

#table(TAULA_PLANA_exc$DM2)
#table(TAULA_PLANA_exc$DG.CKD)

#table(TAULA_PLANA_exc$DM2,TAULA_PLANA_exc$DG.CKD)

table(TAULA_PLANA_exc$DM2,TAULA_PLANA_exc$DG.CKD,dnn = c("DM2","CKD"))

chisq.test(TAULA_PLANA_exc$DM2,TAULA_PLANA_exc$DG.CKD)

#table(TAULA_PLANA_exc$DM2,TAULA_PLANA_exc$DG.CKD,dnn=(a,b))
#              DG.CKD
#            No             Yes
#     No  1824(0.845)       99(0.664)
#DM2  Yes  335(0.155)       50(0.336)***************NO POT SER!!!
#
########

TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.STATINS2=ifelse(FX.STATINS=="Yes" ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.ARB_ACEI_STATINS=ifelse( (FX.ARB=="Yes" | FX.ACEI=="Yes") & (FX.STATINS=="Yes") ,"Si","No"))
TAULA_PLANA_exc<-TAULA_PLANA_exc%>%mutate(FX.NO_ARB_ACEI_STATINS=ifelse( FX.ARB=="No" & FX.ACEI=="No" & FX.STATINS=="No" ,"Si","No"))
#
#dt_temp<-TAULA_PLANA_exc%>%select(PATIENT.ID,FX.ARB,FX.ACEI,FX.STATINS,FX.STATINS2,FX.ARB_ACEI,FX.ARB_ACEI_STATINS,FX.NO_ARB_ACEI_STATINS)
```

## Analisis de fármacos ACEI/ARB / Statines

### Generar un grupo de farmacos excluyentes

```{r}

read_conductor(conductor_codis2) %>% filter(agr%in%c("ACEI","STATINS","ARB")) %>% select(cod,agr) %>% kable(caption = "Codigos incluidos por fàrmaco") %>% kableExtra::kable_styling()


# Descriptiva de farmacs individuals
descrTable(~ FX.ACEI + FX.STATINS + FX.ARB , data= TAULA_PLANA_exc) %>% export2md()

# Generar combinacions
# Descriptiva de combiacions de Farmacs

vars_fx<-c("FX.ACEI","FX.STATINS","FX.ARB")
TAULA_PLANA_exc<- TAULA_PLANA_exc %>% tidyr::unite(FX.ACEI_STATINS_ARB,vars_fx,sep="_",remove = F) 


descrTable(~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB , data= TAULA_PLANA_exc) %>% export2md()

# Capturar variable combinada d'aquests farmacs excloents
popa<-read_conductor(conductor,sheet="COMBI_FARMACOS") %>% select(FX.ACEI_STATINS_ARB,FX.COMBI)

#
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% 
  left_join(popa,by="FX.ACEI_STATINS_ARB")

descrTable(~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB + FX.COMBI, data= TAULA_PLANA_exc, method = 3) %>% export2md()

# etiquetar 
TAULA_PLANA_exc<-TAULA_PLANA_exc %>% etiquetar_valors(variables_factors = conductor,fulla = "COMBI_FARMACOS",camp_etiqueta = "Descripcio")

descrTable(~ FX.ACEI + FX.STATINS + FX.ARB+ FX.ACEI_STATINS_ARB + FX.COMBI, data= TAULA_PLANA_exc, method = 3) %>% export2md()




```


```{r, include=TRUE}
formula<-formula.text("Taula00C",y="FX.COMBI",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=FALSE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. Por combinaciones de Farmacos ACE / ARB / Statins")
#


```


## Analisis de DM global (DM1 , DM2)

```{r, include=TRUE}


read_conductor(conductor_codis2) %>% filter(agr%in%c("DM2","DM1","DM","DM_SEC", "ADO") | agr2=="DM") %>% 
  select(domini,cod,agr,agr2) %>% kable(caption = "Codigos incluidos para DM") %>% kableExtra::kable_styling()


TAULA_PLANA_exc %>% 
  select(GRUP_DIABETIC_CAT,GRUP_DIABETIC_CAT2,G_DIABETIC,GRUP_DM2,DG.DM1,DG.DM2,DG.DM_SEC,DG2.DM,FX.ADO,DG.IRC,DG.CKD,DG2.Diabetic_retinopathy
,DG2.Diabetic_kidney_disease, DG2.MICRO)


#
descrTable(~ GRUP_DIABETIC_CAT + GRUP_DIABETIC_CAT2 +G_DIABETIC +GRUP_DM2 + DG.DM1 +DG.DM2 +DG.DM_SEC +DG2.DM +FX.ADO +DG.IRC +DG.CKD +DG2.Diabetic_retinopathy + DG2.Diabetic_kidney_disease ,data=TAULA_PLANA_exc)


descrTable(G_DIABETIC ~ basal_pacient_valor_HBA1C_ +
             GRUP_DIABETIC_CAT + GRUP_DIABETIC_CAT2 +G_DIABETIC +GRUP_DM2 + DG.DM1 +DG.DM2 +DG.DM_SEC +DG2.DM +FX.ADO +DG.IRC +DG.CKD +DG2.Diabetic_retinopathy + DG2.Diabetic_kidney_disease , method = 2, Q1=0,Q3=1,data=TAULA_PLANA_exc, show.p.overall = F, show.n = T) %>% export2md()



descrTable(Death2~G_DIABETIC+ GRUP_DIABETIC_CAT + DG.DM1 + DG.DM2 ,data=TAULA_PLANA_exc,show.ratio = T, byrow = T) %>% export2md()



c("ajuste13.2","ajuste14.2") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")




c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")



```


```{r resultats1, include=F}
#GRUP_DIABETIC_CAT2		Diabetes_Category	Diabetes_Category( DM2+ADO)

#ia)

formula_i<-formula.text("Taula00C",y="FX.NO_ARB_ACEI_STATINS",taulavariables = conductor,dt=TAULA_PLANA_exc)

descrTable(formula_i,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 3a.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Sin ARB/ACEI/ESTATINAS**")
#
#iia)
formula_ii<-formula.text("Taula00C",y="FX.STATINS2",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_ii,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 3b.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ESTATINAS**")

#
#iiia)
formula_iii<-formula.text("Taula00C",y="FX.ARB_ACEI",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_iii,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 3c.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ACEI o ARB **")
#
#iva)
formula_iv<-formula.text("Taula00C",y="FX.ARB_ACEI_STATINS",taulavariables = conductor,dt=TAULA_PLANA_exc)
descrTable(formula_iv,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 3d.Características de las personas incluidas en el conjunto de datos Covidien-19 OLA 1: data 01.01.2020 – 30.06.2020.(ACEI o ARB) y ESTATINAS **")
```


```{r resultats1.2, include=F}

TAULA_PLANA_exc_b<-TAULA_PLANA_exc%>%filter(GRUP_DIABETIC_CAT!="No Diabetes")


#ib)
descrTable(formula_i,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 4a.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Sin ARB/ACEI/ESTATINAS**")
#
#iib)
descrTable(formula_ii,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
  export2md(caption="**TABLA 4b.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ESTATINAS**")

#
#iiib)
descrTable(formula_iii,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 4c.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020.Solo ACEI o ARB **")
#
#ivb)
descrTable(formula_iv,method =1,
           data=TAULA_PLANA_exc_b,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 4d.Solo DIABETICOS.Características de las personas incluidas en el conjunto de datos Covidien-19 OLA 1: data 01.01.2020 – 30.06.2020.(ACEI o ARB) y ESTATINAS **")


#part bivariada:


formula_v<-formula.text("Taula00C",y="Death",taulavariables = conductor,dt=TAULA_PLANA_exc)
formula_vi<-formula.text("Taula00C",y="Death_DG_Ad_UCI",taulavariables = conductor,dt=TAULA_PLANA_exc)


descrTable(formula_v,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
   export2md(caption="**TABLA 5.Mortalidad y sus Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. **")
#
#ivb)
descrTable(formula_vi,method =1,
           data=TAULA_PLANA_exc,
           max.xlev = 100, 
           show.p.overall=TRUE,
           show.n = T,
           hide.no="No",
           simplify=F) %>% 
 export2md(caption="**TABLA 6.Mortalidad i/o UCI y Características de las personas incluidas en el conjunto de datos Covid-19 en la OLA 1: data 01.01.2020 – 30.06.2020. **")



```

## 5.Modelos descriptivos


```{r resultats2, include=T}
#i) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Type.Of.Diabetes)[5]+(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]
#ii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4] +(Diabetes)[5]+(Microvascular)[6] +(Macrovascular)[7] +(Hypertension)[8]

#iii) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Type.Of.Diabetes)[6]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]
#iv) Death ~(Age.At.Admission)[1] +  (Sex)[2] +(Statin)[3]+(ACE-I)[4]  +(ARB)[5]+(Diabetes)[6]+(Microvascular)[7] +(Macrovascular)[8] +(Hypertension)[9]



#c("ajuste9","ajuste10") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")
#
#c("ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M11", "M12"),
#                   title = "Mortality models",
#                    p.style = "numeric_stars")
#
#
#
# abans:

#c("ajuste9","ajuste10","ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10","M11", "M12"),
#                    title = "Mortality models",
#                    p.style = "numeric_stars")


c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Mortality models",
                    p.style = "numeric_stars")


#Death_DG_Ad_UCI


#c("ajuste9","ajuste10","ajuste11","ajuste12") %>% 
#  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
#  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
#  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M9", "M10","M11", "M12"),
#                    title = "Death y/o UCI  models",
#                    p.style = "numeric_stars")


c("ajuste13","ajuste14") %>% 
  map(~formula.text(.x,"Death_DG_Ad_UCI2",taulavariables = conductor,dt=TAULA_PLANA_exc))%>% 
  map(~glm(.x,data = TAULA_PLANA_exc, family = "binomial")) %>% 
  sjPlot::tab_model(digits=3, show.intercept = F,dv.labels = c("M13", "M14"),
                    title = "Death y/o UCI  models",
                    p.style = "numeric_stars")





```


```




&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>


